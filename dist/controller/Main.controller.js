sap.ui.define(["sap/ui/core/mvc/Controller","sap/ui/model/json/JSONModel","sap/m/MessageBox","../js/Common","sap/ui/model/Filter","sap/ui/model/FilterOperator","sap/ui/core/routing/HashChanger","sap/m/Token","sap/m/ColumnListItem","sap/m/Label","../js/TableValueHelp","../js/TableFilter","jquery.sap.global","sap/ui/Device"],function(e,t,s,a,r,i,l,o,n,d,g,u,c,h){"use strict";var f;var b=sap.ui.core.format.DateFormat.getDateInstance({pattern:"MM/dd/yyyy"});var T=sap.ui.core.format.DateFormat.getDateInstance({pattern:"YYYY-MM-dd"});var p=sap.ui.core.format.DateFormat.getDateInstance({pattern:"yyyyMMdd"});var m=sap.ui.core.format.DateFormat.getTimeInstance({pattern:"KK:mm:ss a"});var M=new Date(0).getTimezoneOffset()*60*1e3;return e.extend("zuimatmaster.controller.Main",{onInit:function(){f=this;this._aColumns={};this._aDataBeforeChange=[];this._validationErrors=[];this._bHdrChanged=false;this._bDtlChanged=false;this._dataMode="READ";this._aColFilters=[];this._aColSorters=[];this._aMultiFiltersBeforeChange=[];this._aFilterableColumns={};this._oViewSettingsDialog={};this._sActiveTable="headerTab";this._oModel=this.getOwnerComponent().getModel();this._tableValueHelp=g;this._tableFilter=u;this._colFilters={};this._oTableLayout={headerTab:{type:"MMHDR",tabname:"ZDVZERPMATL"},attributesTab:{type:"MMATTRIB",tabname:"ZERP_MATATTRIB"},batchTab:{type:"MMBATCH",tabname:"ZERP_MATBATCH"},customInfoTab:{type:"MMCUSTOMINFO",tabname:"ZERP_MATCUSINFO"},plantTab:{type:"MMPLANT",tabname:"MARC"},unitTab:{type:"MMUNIT",tabname:"ZDV_MAT_UNIT"}};this.setSmartFilterModel();var e=this.getOwnerComponent().getModel("ZVB_3DERP_MM_FILTERS_CDS");e.read("/ZVB_3DERP_SBU_SH",{success:function(e,t){if(e.results.length===1){that.getView().getModel("ui").setProperty("/sbu",e.results[0].SBU)}else{}},error:function(e){}});this.getView().setModel(new t({acitveMatno:"",smartfiltergf:0,splittergf:.94,fullscreen:{header:false,detail:false},splitter:{header:"50%",detail:"50%"},dataWrap:{headerTab:false,attributesTab:false,batchTab:false,customInfoTab:false,plantTab:false,unitTab:false}}),"ui");this._counts={header:0,attributes:0,batch:0,customInfo:0,plant:0,unit:0};this.getView().setModel(new t(this._counts),"counts");this.byId("headerTab").setModel(new t({columns:[],rows:[]}));this.byId("attributesTab").setModel(new t({columns:[],rows:[]}));this.byId("batchTab").setModel(new t({columns:[],rows:[]}));this.byId("customInfoTab").setModel(new t({columns:[],rows:[]}));this.byId("plantTab").setModel(new t({columns:[],rows:[]}));this.byId("unitTab").setModel(new t({columns:[],rows:[]}));var s=[],a={};var e=this.getOwnerComponent().getModel("ZGW_3DERP_COMMON_SRV");s.push({CODE:"SBU"});s.push({CODE:"INFO_NO_RECORD_TO_PROC"});s.push({CODE:"INFO_NO_SEL_RECORD_TO_PROC"});s.push({CODE:"INFO_NO_LAYOUT"});s.push({CODE:"INFO_LAYOUT_SAVE"});s.push({CODE:"INFO_INPUT_REQD_FIELDS"});s.push({CODE:"CONFIRM_DISREGARD_CHANGE"});s.push({CODE:"INFO_SEL_RECORD_TO_DELETE"});s.push({CODE:"INFO_DATA_DELETED"});s.push({CODE:"CONF_DELETE_RECORDS"});s.push({CODE:"INFO_ERROR"});s.push({CODE:"INFO_NO_DATA_SAVE"});s.push({CODE:"INFO_DATA_SAVE"});s.push({CODE:"INFO_NO_DATA_EDIT"});s.push({CODE:"INFO_CHECK_INVALID_ENTRIES"});s.push({CODE:"ADD"});s.push({CODE:"EDIT"});s.push({CODE:"ADDROW"});s.push({CODE:"REMOVEROW"});s.push({CODE:"SAVE"});s.push({CODE:"CANCEL"});s.push({CODE:"DELETE"});s.push({CODE:"REFRESH"});s.push({CODE:"COPY"});s.push({CODE:"HASGMC"});s.push({CODE:"INFO_INPUT_REQD_FIELDS"});s.push({CODE:"INFO_NO_DATA_MODIFIED"});s.push({CODE:"INFO_DATA_COPIED"});s.push({CODE:"WRAP"});s.push({CODE:"UNWRAP"});e.create("/CaptionMsgSet",{CaptionMsgItems:s},{method:"POST",success:function(e,s){e.CaptionMsgItems.results.forEach(e=>{a[e.CODE]=e.TEXT});f.getView().setModel(new t(a),"ddtext")},error:function(e){}});var r={onkeyup:function(e){f.onKeyUp(e)},onAfterRendering:function(e){var t=e.srcControl;var s=t.sId.split("--")[t.sId.split("--").length-1];if(s.substr(s.length-3)==="Tab")f._tableRendered=s;else f._tableRendered="";f.onAfterTableRendering()},onclick:function(e){f.onTableClick(e)}};this.byId("headerTab").addEventDelegate(r);this.byId("attributesTab").addEventDelegate(r);this.byId("batchTab").addEventDelegate(r);this.byId("customInfoTab").addEventDelegate(r);this.byId("plantTab").addEventDelegate(r);this.byId("unitTab").addEventDelegate(r);this.getColumnProp();this.byId("headerTab").attachBrowserEvent("mousemove",function(e){});this._oModel.read("/MatTypeSHSet",{async:false,success:function(e){f.getView().setModel(new t(e.results),"MTYP_MODEL")},error:function(e){}});this._oModel.read("/MatGrpRscSet",{async:false,success:function(e){f.getView().setModel(new t(e.results),"MATERIALGRP_MODEL")},error:function(e){}});this._oModel.read("/UOMRscSet",{async:false,success:function(e){f.getView().setModel(new t(e.results),"BASEUOM_MODEL")},error:function(e){}});this._oModel.read("/WeightUnitSet",{async:false,success:function(e){f.getView().setModel(new t(e.results),"WTUOM_MODEL")},error:function(e){}});this._oModel.read("/VolumeUnitSet",{async:false,success:function(e){f.getView().setModel(new t(e.results),"VOLUOM_MODEL")},error:function(e){}});this._oModel.read("/ProcessRscSet",{async:false,success:function(e){f.getView().setModel(new t(e.results),"PROCESSCD_MODEL")},error:function(e){}});this._oModel.read("/DimensionUnitSet",{async:false,success:function(e){f.getView().setModel(new t(e.results),"DIMUOM_MODEL")},error:function(e){}});this._oModel.read("/PurValKeyRscSet",{async:false,success:function(e){f.getView().setModel(new t(e.results),"PURCHASEVALUE_MODEL")},error:function(e){}})},onSearch:function(){this.getMain()},setSmartFilterModel:function(){var e=this.getOwnerComponent().getModel("ZVB_3DERP_MM_FILTERS_CDS");var t=this.getView().byId("smartFilterBar");t.setModel(e)},getColumnProp:async function(){var e=c.sap.getModulePath("zuimatmaster","/model/columns.json");var s=new t;await s.loadData(e);var a=s.getData();this._oModelColumns=s.getData();setTimeout(()=>{this.getDynamicColumns("MMHDR","ZDVZERPMATL","headerTab",a)},100);setTimeout(()=>{this.getDynamicColumns("MMATTRIB","ZERP_MATATTRIB","attributesTab",a)},100);setTimeout(()=>{this.getDynamicColumns("MMBATCH","ZERP_MATBATCH","batchTab",a)},100);setTimeout(()=>{this.getDynamicColumns("MMCUSTOMINFO","ZERP_MATCUSINFO","customInfoTab",a)},100);setTimeout(()=>{this.getDynamicColumns("MMPLANT","MARC","plantTab",a)},100);setTimeout(()=>{this.getDynamicColumns("MMUNIT","ZDV_MAT_UNIT","unitTab",a)},100)},getDynamicColumns(e,s,a,r){var i=this;var l=e;var o=s;var n=a;var d=r;var g=this.getOwnerComponent().getModel("ZGW_3DERP_COMMON_SRV");var u="VER";g.setHeaders({sbu:u,type:l,tabname:o});g.read("/ColumnsSet",{success:function(e,s){if(e.results.length>0){if(d[n.replace("Tab","")]!==undefined){e.results.forEach(e=>{d[n.replace("Tab","")].filter(t=>t.ColumnName===e.ColumnName).forEach(t=>{e.ValueHelp=t.ValueHelp;e.TextFormatMode=t.TextFormatMode})})}i._aColumns[n.replace("Tab","")]=e.results;i.setTableColumns(n,e.results);var a=i.getView().getModel("ddtext").getData();e.results.forEach(e=>{a[e.ColumnName]=e.ColumnLabel});i.getView().setModel(new t(a),"ddtext")}},error:function(e){}})},setTableColumns(e,t){var s=e;var a=t;var r=this.getView().byId(s);r.getModel().setProperty("/columns",a);r.bindColumns("/columns",function(e,t){var a=t.getObject().ColumnName;var r=t.getObject().ColumnLabel;var i=t.getObject().ColumnWidth;var l=t.getObject().Visible;var o=t.getObject().Sorted;var n=t.getObject().SortOrder;var d=t.getObject().DataType;if(i===0)i=100;var g=new sap.m.Text({wrapping:false});var u=f._aColumns[s.replace("Tab","")].filter(e=>e.ColumnName===a);if(u&&u.length>0&&u[0].ValueHelp&&u[0].ValueHelp["items"].text&&u[0].ValueHelp["items"].value!==u[0].ValueHelp["items"].text&&u[0].TextFormatMode&&u[0].TextFormatMode!=="Key"){g.bindText({parts:[{path:a}],formatter:function(e){var t=f.getView().getModel(u[0].ValueHelp["items"].path).getData().filter(t=>t[u[0].ValueHelp["items"].value]===e);if(t&&t.length>0){if(u[0].TextFormatMode==="Value"){return t[0][u[0].ValueHelp["items"].text]}else if(u[0].TextFormatMode==="ValueKey"){return t[0][u[0].ValueHelp["items"].text]+" ("+e+")"}else if(u[0].TextFormatMode==="KeyValue"){return e+" ("+t[0][u[0].ValueHelp["items"].text]+")"}}else return e}})}else{g.bindText({parts:[{path:a}]})}if(s==="headerTab"){if(a==="HASGMC"){d="BOOLEAN"}else if(a==="UEBTK"){d="BOOLEAN"}}else if(s==="plantTab"){if(a==="LVORM"){d="BOOLEAN"}}return new sap.ui.table.Column({id:s.replace("Tab","")+"Col"+a,label:new sap.m.Text({text:r}),template:d==="BOOLEAN"?new sap.m.CheckBox({selected:"{"+a+"}",editable:false}):g,width:i+"px",sortProperty:a,autoResizable:true,visible:l,sorted:o,hAlign:d==="NUMBER"?"End":d==="BOOLEAN"?"Center":"Begin",sortOrder:o===true?n:"Ascending"})});r.attachSort(function(e){var t=e.getParameter("column").getSortProperty();var s=false;r.getColumns().forEach(e=>{if(e.getSorted()){e.setSorted(false)}});e.getParameter("column").setSorted(true);if(e.getParameter("sortOrder")==="Descending"){s=true;e.getParameter("column").setSortOrder("Descending")}else{e.getParameter("column").setSortOrder("Ascending")}var i=new sap.ui.model.Sorter(t,s);var l=a.filter(t=>t.ColumnName===e.getParameter("column").getProperty("sortProperty"));var o=l[0].DataType;if(o==="DATETIME"){i.fnCompare=function(e,t){var s=new Date(e);var a=new Date(t);if(a===null){return-1}if(s===null){return 1}if(s<a){return-1}if(s>a){return 1}return 0}}else if(o==="NUMBER"){i.fnCompare=function(e,t){var s=+e;var a=+t;if(a===null){return-1}if(s===null){return 1}if(s<a){return-1}if(s>a){return 1}return 0}}r.getBinding("rows").sort(i);e.preventDefault()});u.updateColumnMenu(s,this)},onTableClick(e){var t=e.srcControl;var s=t.sId.split("--")[t.sId.split("--").length-1];while(s.substr(s.length-3)!=="Tab"){t=t.oParent;s=t.sId.split("--")[t.sId.split("--").length-1]}if(this._dataMode==="READ")this._sActiveTable=s},onSaveTableLayout:function(e){this._sActiveTable=e.getSource().data("TableId");var t=this.byId(this._sActiveTable);var a=t.getColumns();var r="VER";var i=this;var l=1;var o={SBU:r,TYPE:this._oTableLayout[this._sActiveTable].type,TABNAME:this._oTableLayout[this._sActiveTable].tabname,TableLayoutToItems:[]};a.forEach(e=>{o.TableLayoutToItems.push({COLUMNNAME:e.mProperties.sortProperty,ORDER:l.toString(),SORTED:e.mProperties.sorted,SORTORDER:e.mProperties.sortOrder,SORTSEQ:"1",VISIBLE:e.mProperties.visible,WIDTH:e.mProperties.width.replace("px","")});l++});console.log(o);var n=this.getOwnerComponent().getModel("ZGW_3DERP_COMMON_SRV");n.create("/TableLayoutSet",o,{method:"POST",success:function(e,t){s.information(i.getView().getModel("ddtext").getData()["INFO_LAYOUT_SAVE"])},error:function(e){s.error(e)}})},onAfterTableRendering:function(e){if(this._tableRendered!==""){this.setActiveRowHighlightByTableId(this._tableRendered);this._tableRendered=""}},setActiveRowHighlightByTableId(e){var t=this.byId(e);setTimeout(()=>{var e=t.getModel().getData().rows.findIndex(e=>e.ACTIVE==="X");t.getRows().forEach(t=>{if(t.getBindingContext()&&+t.getBindingContext().sPath.replace("/rows/","")===e){t.addStyleClass("activeRow")}else t.removeStyleClass("activeRow")})},10)},getMain(){a.openLoadingDialog(this);var e=this.getOwnerComponent().getModel();var t=this.getView().byId("smartFilterBar").getFilters();console.log("aFilters",t);var s=this;var r="VER";e.read("/MaterialSet",{filters:t,success:function(e,t){if(e.results.length>0){e.results.sort((e,t)=>new Date(t.CREATEDDT)-new Date(e.CREATEDDT)||parseInt(t.MATERIALNO)-parseInt(e.MATERIALNO))}e.results.forEach((e,t)=>{e.HASGMC=e.HASGMC==="X"?true:false;if(e.CREATEDDT!==null)e.CREATEDDT=b.format(new Date(e.CREATEDDT));if(e.UPDATEDDATE!==null)e.UPDATEDDATE=b.format(new Date(e.UPDATEDDATE));if(t===0){e.ACTIVE="X";f.getView().getModel("ui").setProperty("/acitveMatno",e.MATERIALNO);f.getAttributes(e.MATERIALNO);f.getBatch(e.MATERIALNO);f.getCustomInfo(e.MATERIALNO);f.getPlant(e.MATERIALNO);f.getUnit(e.MATERIALNO)}else{e.ACTIVE=""}});f.byId("headerTab").getModel().setProperty("/rows",e.results);f.byId("headerTab").bindRows("/rows");f.getView().getModel("counts").setProperty("/header",e.results.length);a.closeLoadingDialog(f)},error:function(e){a.closeLoadingDialog(f)}})},getAttributes(e){var t=this.getOwnerComponent().getModel();var s="/MaterialAtrribSet";t.read(s,{urlParameters:{$filter:"MATNO eq '"+e+"'"},success:function(e,t){if(e.results.length>0){e.results.forEach(e=>{if(e.CREATEDDT!==null){e.CREATEDDT=b.format(new Date(e.CREATEDDT))}if(e.UPDATEDDT!==null){e.UPDATEDDT=b.format(new Date(e.UPDATEDDT))}})}f.byId("attributesTab").getModel().setProperty("/rows",e.results);f.byId("attributesTab").bindRows("/rows");f.getView().getModel("counts").setProperty("/attributes",e.results.length);a.closeLoadingDialog(f)},error:function(e){a.closeLoadingDialog(f)}})},getBatch(e){var t=this.getOwnerComponent().getModel();var s="/MaterialBatchSet";t.read(s,{urlParameters:{$filter:"MATNO eq '"+e+"'"},success:function(e,t){if(e.results.length>0){e.results.forEach(e=>{if(e.CREATEDDT!==null){e.CREATEDDT=b.format(new Date(e.CREATEDDT))}if(e.UPDATEDDT!==null){e.UPDATEDDT=b.format(new Date(e.UPDATEDDT))}})}f.byId("batchTab").getModel().setProperty("/rows",e.results);f.byId("batchTab").bindRows("/rows");f.getView().getModel("counts").setProperty("/batch",e.results.length);a.closeLoadingDialog(f)},error:function(e){a.closeLoadingDialog(f)}})},getCustomInfo(e){var t=this.getOwnerComponent().getModel();var s="/MaterialCusInfoSet";t.read(s,{urlParameters:{$filter:"MATNO eq '"+e+"'"},success:function(e,t){if(e.results.length>0){e.results.forEach(e=>{if(e.CREATEDDT!==null){e.CREATEDDT=b.format(new Date(e.CREATEDDT))}if(e.UPDATEDDT!==null){e.UPDATEDDT=b.format(new Date(e.UPDATEDDT))}})}f.byId("customInfoTab").getModel().setProperty("/rows",e.results);f.byId("customInfoTab").bindRows("/rows");f.getView().getModel("counts").setProperty("/customInfo",e.results.length);a.closeLoadingDialog(f)},error:function(e){a.closeLoadingDialog(f)}})},getPlant(e){var t=this.getOwnerComponent().getModel();var s="/PlantSet";t.read(s,{urlParameters:{$filter:"MATNR eq '"+e+"'"},success:function(e,t){if(e.results.length>0){e.results.forEach(e=>{if(e.CREATEDDT!==null){e.CREATEDDT=b.format(new Date(e.CREATEDDT))}if(e.UPDATEDDT!==null){e.UPDATEDDT=b.format(new Date(e.UPDATEDDT))}})}f.byId("plantTab").getModel().setProperty("/rows",e.results);f.byId("plantTab").bindRows("/rows");f.getView().getModel("counts").setProperty("/plant",e.results.length);a.closeLoadingDialog(f)},error:function(e){a.closeLoadingDialog(f)}})},getUnit(e){var t=this.getOwnerComponent().getModel();var s="/UnitMeasureSet";t.read(s,{urlParameters:{$filter:"MATNO eq '"+e+"'"},success:function(e,t){f.byId("unitTab").getModel().setProperty("/rows",e.results);f.byId("unitTab").bindRows("/rows");f.getView().getModel("counts").setProperty("/unit",e.results.length);a.closeLoadingDialog(f)},error:function(e){a.closeLoadingDialog(f)}})},onColFilterClear:function(e){u.onColFilterClear(e,this)},onColFilterCancel:function(e){u.onColFilterCancel(e,this)},onColFilterConfirm:function(e){u.onColFilterConfirm(e,this)},onFilterItemPress:function(e){u.onFilterItemPress(e,this)},onFilterValuesSelectionChange:function(e){u.onFilterValuesSelectionChange(e,this)},onSearchFilterValue:function(e){u.onSearchFilterValue(e,this)},onCustomColFilterChange:function(e){u.onCustomColFilterChange(e,this)},onSetUseColFilter:function(e){u.onSetUseColFilter(e,this)},onRemoveColFilter:function(e){u.onRemoveColFilter(e,this)},onRefresh:function(e){var t=e.getSource().oParent.oParent;var s=t.sId.split("--")[t.sId.split("--").length-1];this._sActiveTable=s;this.refreshData()},refreshData(){if(this._dataMode==="READ"){this._aColFilters=this.byId(this._sActiveTable).getBinding("rows").aFilters;this._aColSorters=this.byId(this._sActiveTable).getBinding("rows").aSorters;var e=this.getView().getModel("ui").getProperty("/acitveMatno");a.openLoadingDialog(this);if(this._sActiveTable==="headerTab"){this.getMain()}else if(this._sActiveTable==="attributesTab"){this.getAttributes(e)}else if(this._sActiveTable==="batchTab"){this.getBatch(e)}else if(this._sActiveTable==="customInfoTab"){this.getCustomInfo(e)}else if(this._sActiveTable==="plantTab"){this.getPlant(e)}else if(this._sActiveTable==="unitTab"){this.getUnit(e)}}},onWrapText:function(e){this._sActiveTable=e.getSource().data("TableId");var t=this.getView().getModel("ui").getData().dataWrap[this._sActiveTable];this.byId(this._sActiveTable).getColumns().forEach(e=>{var s=e.getTemplate();if(s instanceof sap.m.Text){s.setWrapping(!t);e.setTemplate(s)}});this.getView().getModel("ui").setProperty("/dataWrap/"+[this._sActiveTable],!t)},onCreate:function(e){var t=e.getSource().oParent.oParent;var s=t.sId.split("--")[t.sId.split("--").length-1];this._sActiveTable=s;this.byId("splitterHdr").setProperty("size","100%");this.byId("splitterDtl").setProperty("size","0%");this.createData()},createData(){if(this._dataMode==="READ"){if(this._sActiveTable==="headerTab"){this.byId("btnAddHdr").setVisible(false);this.byId("btnEditHdr").setVisible(false);this.byId("btnDeleteHdr").setVisible(false);this.byId("btnRefreshHdr").setVisible(false);this.byId("btnAddRowHdr").setVisible(true);this.byId("btnRemoveRowHdr").setVisible(true);this.byId("btnSaveHdr").setVisible(true);this.byId("btnCancelHdr").setVisible(true);this.byId("btnFullScreenHdr").setVisible(false);this.byId("btnExitFullScreenHdr").setVisible(false);this.byId("smartFilterBar").setVisible(false)}var e=this.byId(this._sActiveTable);this._aDataBeforeChange=c.extend(true,[],e.getModel().getData().rows);this._validationErrors=[];if(e.getBinding("rows").aApplicationFilters.length>0){this._aMultiFiltersBeforeChange=this._aFilterableColumns["gmc"].filter(e=>e.value!=="");e.getBinding("rows").filter("","Application")}if(e.getBinding("rows").aFilters.length>0){this._aColFilters=c.extend(true,[],e.getBinding("rows").aFilters);e.getBinding("rows").aFilters=[]}if(e.getBinding("rows").aSorters.length>0){this._aColSorters=c.extend(true,[],e.getBinding("rows").aSorters)}var t=e.getColumns();for(var s=0,a=t.length;s<a;s++){var r=t[s].getFiltered();if(r){t[s].filter("")}}this.setRowCreateMode()}},setRowCreateMode(){var e=this.byId(this._sActiveTable);var t=[];var s={};e.getColumns().forEach((e,t)=>{var a="";var r=false;if(e.mAggregations.template.mBindingInfos.text!==undefined){a=e.mAggregations.template.mBindingInfos.text.parts[0].path}else if(e.mAggregations.template.mBindingInfos.selected!==undefined){a=e.mAggregations.template.mBindingInfos.selected.parts[0].path}else if(e.mAggregations.template.mBindingInfos.value!==undefined){a=e.mAggregations.template.mBindingInfos.value.parts[0].path}this._aColumns[this._sActiveTable.replace("Tab","")].filter(e=>e.ColumnName===a).forEach(t=>{if(t.Editable||t.Creatable){if(t.ValueHelp!==undefined)r=t.ValueHelp["show"];if(r){var i=false;var l=t.ValueHelp["SuggestionItems"].text;var o=t.ValueHelp["SuggestionItems"].additionalText!==undefined?t.ValueHelp["SuggestionItems"].additionalText:"";var n="Key";if(t.TextFormatMode&&t.TextFormatMode!==""&&t.TextFormatMode!=="Key"&&t.ValueHelp["items"].value!==t.ValueHelp["items"].text){n=t.TextFormatMode;i=true;if(t.ValueHelp["SuggestionItems"].additionalText&&t.ValueHelp["SuggestionItems"].text!==t.ValueHelp["SuggestionItems"].additionalText){if(n==="ValueKey"||n==="Value"){l=t.ValueHelp["SuggestionItems"].additionalText;o=t.ValueHelp["SuggestionItems"].text}}}var d=new sap.m.Input({type:"Text",showValueHelp:true,valueHelpRequest:g.handleTableValueHelp.bind(this),showSuggestion:true,maxSuggestionWidth:t.ValueHelp["SuggestionItems"]?.additionalText?t.ValueHelp["SuggestionItems"].maxSuggestionWidth:"1px",suggestionItems:{path:t.ValueHelp["SuggestionItems"].path,length:1e4,template:new sap.ui.core.ListItem({key:t.ValueHelp["SuggestionItems"].text,text:l,additionalText:o}),templateShareable:false},change:this.handleValueHelpChange.bind(this)});if(i){d.setProperty("textFormatMode",n);d.bindValue({parts:[{path:a},{value:t.ValueHelp?.items?.path},{value:t.ValueHelp?.items?.value},{value:t.ValueHelp?.items?.text},{value:n}],formatter:this.formatValueHelp.bind(this)})}else{d.bindValue({parts:[{path:a}]})}e.setTemplate(d)}else if(t.DataType==="DATETIME"){if(this._sActiveTable==="costHdrTab"&&a==="CSDATE"){e.setTemplate(new sap.m.DatePicker({value:"{path: '"+t.ColumnName+"', mandatory: '"+t.Mandatory+"'}",displayFormat:"MM/dd/yyyy",valueFormat:"MM/dd/yyyy",change:this.onInputLiveChange.bind(this),enabled:{path:"COSTSTATUS",formatter:function(e){if(e==="REL"){return false}else{return true}}}}))}else{e.setTemplate(new sap.m.DatePicker({value:"{path: '"+t.ColumnName+"', mandatory: '"+t.Mandatory+"'}",displayFormat:"MM/dd/yyyy",valueFormat:"MM/dd/yyyy",change:this.onInputLiveChange.bind(this)}))}}else if(t.DataType==="NUMBER"){e.setTemplate(new sap.m.Input({type:sap.m.InputType.Number,textAlign:sap.ui.core.TextAlign.Right,value:"{path:'"+a+"', formatOptions:{ minFractionDigits:"+t.Decimal+", maxFractionDigits:"+t.Decimal+" }, constraints:{ precision:"+t.Length+", scale:"+t.Decimal+" }}",liveChange:this.onNumberLiveChange.bind(this)}))}else if(t.DataType==="BOOLEAN"){e.setTemplate(new sap.m.CheckBox({selected:"{"+a+"}",editable:true}))}else{if(this._sActiveTable==="ioMatListTab"&&a==="MATDESC1"){e.setTemplate(new sap.m.Input({type:"Text",value:"{"+a+"}",maxLength:t.Length,change:this.onInputLiveChange.bind(this),enabled:{path:"MATNO",formatter:function(e){if(e!==""){return false}else{return true}}}}))}else if(this._sActiveTable==="costHdrTab"&&a==="VERDESC"){e.setTemplate(new sap.m.Input({type:"Text",value:"{"+a+"}",maxLength:t.Length,change:this.onInputLiveChange.bind(this),enabled:{path:"COSTSTATUS",formatter:function(e){if(e==="REL"){return false}else{return true}}}}))}else{e.setTemplate(new sap.m.Input({type:"Text",value:"{"+a+"}",maxLength:t.Length,change:this.onInputLiveChange.bind(this)}))}}if(t.Mandatory){e.getLabel().addStyleClass("sapMLabelRequired")}if(t.DataType==="STRING")s[a]="";else if(t.DataType==="NUMBER")s[a]=0;else if(t.DataType==="BOOLEAN")s[a]=false}})});s["NEW"]=true;t=this.byId(this._sActiveTable).getModel().getProperty("/rows").filter(e=>e.NEW===true);t.push(s);this.byId(this._sActiveTable).getModel().setProperty("/rows",t);this.byId(this._sActiveTable).bindRows("/rows");this._dataMode="NEW";e.focus()},setRowReadMode(){var e=this.byId(this._sActiveTable);var t="";e.getColumns().forEach((e,s)=>{if(e.mAggregations.template.mBindingInfos.text!==undefined){t=e.mAggregations.template.mBindingInfos.text.parts[0].path}else if(e.mAggregations.template.mBindingInfos.selected!==undefined){t=e.mAggregations.template.mBindingInfos.selected.parts[0].path}else if(e.mAggregations.template.mBindingInfos.value!==undefined){t=e.mAggregations.template.mBindingInfos.value.parts[0].path}this._aColumns[this._sActiveTable.replace("Tab","")].filter(e=>e.ColumnName===t).forEach(s=>{if(s.TextFormatMode&&s.TextFormatMode!==""&&s.TextFormatMode!=="Key"&&s.ValueHelp&&s.ValueHelp["items"].text&&s.ValueHelp["items"].value!==s.ValueHelp["items"].text){e.setTemplate(new sap.m.Text({text:{parts:[{path:t}],formatter:function(e){var t=f.getView().getModel(s.ValueHelp["items"].path).getData().filter(t=>t[s.ValueHelp["items"].value]===e);if(t&&t.length>0){if(s.TextFormatMode==="Value"){return t[0][s.ValueHelp["items"].text]}else if(s.TextFormatMode==="ValueKey"){return t[0][s.ValueHelp["items"].text]+" ("+e+")"}else if(s.TextFormatMode==="KeyValue"){return e+" ("+t[0][s.ValueHelp["items"].text]+")"}}else return e}},wrapping:false}))}else if(s.DataType==="STRING"||s.DataType==="DATETIME"||s.DataType==="NUMBER"){e.setTemplate(new sap.m.Text({text:"{"+t+"}",wrapping:false}))}else if(s.DataType==="BOOLEAN"){e.setTemplate(new sap.m.CheckBox({selected:"{"+t+"}",editable:false}))}});e.getLabel().removeStyleClass("sapMLabelRequired")});this.byId(this._sActiveTable).getModel().getData().rows.forEach(e=>e.EDITED=false)},onTableResize:function(e){this._sActiveTable=e.getSource().data("TableId");var t=e.getSource().data("Max")==="1"?true:false;var s=e.getSource().data("ButtonIdSuffix");var a=e.getSource().data("Header");var r=this;this.byId("btnFullScreen"+s).setVisible(!t);this.byId("btnExitFullScreen"+s).setVisible(t);if(t){if(a==="1"){this.byId("splitterHdr").setProperty("size","100%");this.byId("splitterDtl").setProperty("size","0%")}else{this.byId("splitterHdr").setProperty("size","0%");this.byId("splitterDtl").setProperty("size","100%")}}else{this.byId("splitterHdr").setProperty("size","50%");this.byId("splitterDtl").setProperty("size","50%")}},onInputLiveChange:function(e){var t=e.getSource();var s=t.getBindingInfo("value").binding.oContext.sPath;this.byId(this._sActiveTable).getModel().setProperty(s+"/EDITED",true);if(this._sActiveTable==="headerTab")this._bHdrChanged=true;else if(this._sActiveTable==="detailTab")this._bDtlChanged=true},onNumberLiveChange:function(e){var t=e.getSource();var s=t.getBindingInfo("value").constraints.scale;var a=t.getBindingInfo("value").constraints.precision;if(e.getParameters().value.split(".")[0].length>a-s){e.getSource().setValueState("Error");e.getSource().setValueStateText("Enter a number with a maximum whole number length of "+(a-s));if(this._validationErrors.filter(t=>t===e.getSource().getId()).length===0){this._validationErrors.push(e.getSource().getId())}}else if(e.getParameters().value.split(".").length>1){if(s===0){e.getSource().setValueState("Error");e.getSource().setValueStateText("Enter a number without decimal place/s");if(this._validationErrors.filter(t=>t===e.getSource().getId()).length===0){this._validationErrors.push(e.getSource().getId())}}else{if(e.getParameters().value.split(".")[1].length>s){e.getSource().setValueState("Error");e.getSource().setValueStateText("Enter a number with a maximum of "+s.toString()+" decimal places");if(this._validationErrors.filter(t=>t===e.getSource().getId()).length===0){this._validationErrors.push(e.getSource().getId())}}else{e.getSource().setValueState("None");this._validationErrors.forEach((t,s)=>{if(t===e.getSource().getId()){this._validationErrors.splice(s,1)}})}}}else{e.getSource().setValueState("None");this._validationErrors.forEach((t,s)=>{if(t===e.getSource().getId()){this._validationErrors.splice(s,1)}})}var r=t.getBindingInfo("value").binding.oContext.sPath;this.byId(this._sActiveTable).getModel().setProperty(r+"/EDITED",true);if(this._sActiveTable==="headerTab")this._bHdrChanged=true;else if(this._sActiveTable==="detailTab")this._bDtlChanged=true},handleValueHelpChange:function(e){var s=e.getSource();var a=s.oParent.getBindingContext().sPath;var r=!s.getSelectedKey()&&s.getValue().trim();var i=s.getBindingInfo("suggestionItems").model;var l="VER";s.getSuggestionItems().forEach(e=>{if(s.getSelectedKey()===""&&s.getValue()!==""){if(s.getProperty("textFormatMode")==="ValueKey"&&e.getProperty("text")+" ("+e.getProperty("key")+")"===s.getValue()){s.setSelectedKey(e.getProperty("key"));r=false;s.setValueState(r?"Error":"None")}else if((s.getProperty("textFormatMode")==="Value"||s.getProperty("textFormatMode")==="Key")&&e.getProperty("key")===s.getValue()){s.setSelectedKey(e.getProperty("key"));r=false;s.setValueState(r?"Error":"None")}}else if(e.getProperty("key")===s.getSelectedKey()){r=false;s.setValueState(r?"Error":"None")}});if(r)this._validationErrors.push(e.getSource().getId());else{const e=this.byId(this._sActiveTable).getModel();switch(i){case"MTYP_MODEL":var o=this.getView().byId("headerTab");var n=f.getView().getModel("MTYP_MODEL").getData().filter(e=>e.Mattyp===s.getSelectedKey());e.setProperty(a+"/HASGMC",n[0].Hasgmc==="X"?true:false);e.setProperty(a+"/GROSSWT","0.000");e.setProperty(a+"/NETWT","0.000");e.setProperty(a+"/VOLUME","0.000");e.setProperty(a+"/UEBTK",false);e.setProperty(a+"/MATERIALGROUP","");e.setProperty(a+"/GMC","");e.setProperty(a+"/BASEUOM","");e.setProperty(a+"/WTUOM","");e.setProperty(a+"/VOLUMEUOM","");e.setProperty(a+"/MATERIALGROUP","");e.setProperty(a+"/CUSTMATCODE","");e.setProperty(a+"/PROCESSCODE","");e.setProperty(a+"/UEBTO","");e.setProperty(a+"/UNTTO","");e.setProperty(a+"/UEBTK",false);if(n[0].Hasgmc==="X"){o.getColumns().forEach((e,t)=>{const s=e.getId().replace(this._sActiveTable.replace("Tab","")+"Col","");switch(s){case"MATERIALGROUP":case"GROSSWT":case"NETWT":case"WTUOM":case"VOLUME":case"VOLUMEUOM":case"CUSTMATLNO":case"PROCESSCODE":case"ORDERUOM":case"BASEUOM":case"GROSSWT":{o.getRows()[0].getCells()[t].setProperty("editable",false);break}case"GMC":{o.getRows()[0].getCells()[t].setProperty("editable",true);break}}});this._oModel.read("/GMCRscSet",{urlParameters:{$filter:"Mattyp eq '"+s.getSelectedKey()+"' and Sbu eq '"+l+"'"},async:false,success:function(e){f.getView().setModel(new t(e.results),"GMC_MODEL")},error:function(e){}})}else{o.getColumns().forEach((e,t)=>{const s=e.getId().replace(this._sActiveTable.replace("Tab","")+"Col","");switch(s){case"MATERIALGROUP":case"GROSSWT":case"NETWT":case"WTUOM":case"VOLUME":case"VOLUMEUOM":case"CUSTMATLNO":case"PROCESSCODE":case"ORDERUOM":case"BASEUOM":case"GROSSWT":{o.getRows()[0].getCells()[t].setProperty("editable",true);break}case"GMC":{o.getRows()[0].getCells()[t].setProperty("editable",false);break}}})}break;case"GMC_MODEL":var d=f.getView().getModel("GMC_MODEL").getData().filter(e=>e.Gmc===s.getSelectedKey());e.setProperty(a+"/MATERIALGROUP","");e.setProperty(a+"/BASEUOM","");e.setProperty(a+"/GROSSWT","");e.setProperty(a+"/NETWT","");e.setProperty(a+"/WTUOM","");e.setProperty(a+"/VOLUME","");e.setProperty(a+"/VOLUMEUOM","");e.setProperty(a+"/CUSTMATCODE","");e.setProperty(a+"/MATERIALGROUP",d[0].Matgrpcd);e.setProperty(a+"/BASEUOM",d[0].Baseuom);e.setProperty(a+"/GROSSWT",d[0].Grswt);e.setProperty(a+"/NETWT",d[0].Netwt);e.setProperty(a+"/WTUOM",d[0].Wtuom);e.setProperty(a+"/VOLUME",d[0].Volume);e.setProperty(a+"/VOLUMEUOM",d[0].Voluom);e.setProperty(a+"/CUSTMATCODE",d[0].Cusmatcd);break;case"PURCHASEVALUE_MODEL":var g=f.getView().getModel("PURCHASEVALUE_MODEL").getData().filter(e=>e.Ekwsl===s.getSelectedKey());e.setProperty(a+"/UEBTO","");e.setProperty(a+"/UNTTO","");e.setProperty(a+"/UEBTK",false);e.setProperty(a+"/UEBTO",g[0].Uebto);e.setProperty(a+"/UNTTO",g[0].Untto);e.setProperty(a+"/UEBTK",g[0].Uebtk==="X"?true:false);break}}this.byId(this._sActiveTable).getModel().setProperty(a+"/EDITED",true);if(this._sActiveTable==="headerTab")this._bHdrChanged=true;else if(this._sActiveTable==="detailTab")this._bDtlChanged=true},onAddRow(){this.setRowCreateMode()},onRemoveRow(){var e=this.byId(this._sActiveTable);var t=e.getModel().getProperty("/rows").filter(e=>e.NEW===true);t.splice(e.getSelectedIndices(),1);e.getModel().setProperty("/rows",t);e.bindRows("/rows")},onSaveHdr(){var e=this.byId(this._sActiveTable).getModel().getData().rows.filter(e=>e.NEW===true);var a=this.getOwnerComponent().getModel();var r=this.getOwnerComponent().getModel();var i=new t;var l=new t;var o="VER";var n={results:[]};e.forEach((e,t)=>{e.NEWSEQ=t});console.log("aNewRows",e);this.onMaterialTypeClassDialog(e);e.forEach((t,r)=>{a.read("/MRPTypeSet",{urlParameters:{$filter:"Screencode eq 'BAPI_MATNR' and Mtart eq '"+t.MATERIALTYPE+"'"},success:function(t,s){if(t.results.length>0){n.results.push(t.results[0])}if(r==e.length-1){i.setData(n);f.getView().setModel(i,"mrpTypeClass")}},error:function(e){s.information(e)}})});r.read("/MatPlantSet",{urlParameters:{$filter:"SBU eq '"+o+"'"},success:function(e,t){l.setData(e);f.getView().setModel(l,"matPlantClass")},error:function(e){}})},createDialog:null,onMaterialTypeClassDialog(e){console.log("args",e);var s=this.getOwnerComponent().getModel();var a=new t;var r=this;var i={results:[]};var l=e.map(e=>e.MATERIALTYPE);console.log("aMatType",l);l.forEach((o,n)=>{this.newMattyp=o;s.read("/MatTypeClassSet",{urlParameters:{$filter:"Mattyp eq '"+this.newMattyp+"'"},success:function(s,o){console.log(s);var d=JSON.parse(JSON.stringify(s));d.results.forEach(t=>{t.Gmc=e[n].GMC;t.Descen="";t.Desczh="";t.Attrib=t.Attrib==="X"?true:false;t.Createddt=b.format(new Date(t.Createddt));t.Updateddt=b.format(new Date(t.Updateddt));t.DescInput=t.Attrib==="X"?false:true});i.results.push(...d.results);if(n==l.length-1){i.results.forEach((e,t)=>{e.NEWSEQ=t});a.setData(i);r.getView().setModel(a,"mtClassModel");r.createViewSettingsDialog("matTypeClass",new t({items:i.results,rowCount:i.results.length}));var g=r._oViewSettingsDialog["zuimatmaster.view.fragments.MaterialTypeClassDialog"];g.getModel().setProperty("/items",i.results);g.getModel().setProperty("/rowCount",i.results.length);g.open()}},error:function(e){}})})},createViewSettingsDialog:function(e,t){var s=null;if(e==="sort")s="zuimatmaster.view.SortDialog";else if(e==="filter")s="zuimatmaster.view.FilterDialog";else if(e==="column")s="zuimatmaster.view.ColumnDialog";else if(e==="matTypeClass")s="zuimatmaster.view.fragments.MaterialTypeClassDialog";var a=this._oViewSettingsDialog[s];if(!a){a=sap.ui.xmlfragment(s,this);if(h.system.desktop){a.addStyleClass("sapUiSizeCompact")}a.setModel(t);this._oViewSettingsDialog[s]=a;this.getView().addDependent(a)}else{a.setModel(t)}},onCreateMMCancel(){this._oViewSettingsDialog["zuimatmaster.view.fragments.MaterialTypeClassDialog"].close()},onCreateMMSave:async function(){var e="VER";var t=[],r=[];var i=this;this.getView().getModel("mtClassModel").getData().results.forEach(e=>{if(e.Desczh==="")e.Desczh=e.Descen;if(e.Inclindesc==="X"){if(e.Descen!=="")t.push(e.Descen);if(e.Desczh!=="")r.push(e.Desczh)}});if(t.join("")===""){s.information("At least one description should be specified.")}else{a.openProcessingDialog(f,"Processing...");var l=this.byId(this._sActiveTable).getModel().getData().rows.filter(e=>e.NEW===true);var o="";var n=false;var d=[];i._bErrorCreateMM=false;for(var g=0;g<l.length;g++){var u=l[g];t=[];r=[];i.getView().getModel("mtClassModel").getData().results.forEach(e=>{if(e.Mattyp==u.MATERIALTYPE&&e.NEWSEQ==u.NEWSEQ){if(e.Desczh==="")e.Desczh=e.Descen;if(e.Inclindesc==="X"){if(e.Descen!=="")t.push(e.Descen);if(e.Desczh!=="")r.push(e.Desczh)}}});var c=t.join(", ");var h=r.join(", ");var b={};var T="";var p=[];var m=[];i.getView().getModel("mtClassModel").getData().results.forEach((e,t)=>{if(e.Mattyp==u.MATERIALTYPE&&e.NEWSEQ==u.NEWSEQ){m.push({Seq:"1",Seqno:t+1+"",Mattypcls:e.Mattypcls,Attribcd:e.Attribcd,Descen:e.Descen,Desczh:e.Desczh})}});var M=i.getView().getModel("mrpTypeClass").getData().results.filter(e=>e.Mtart==u.MATERIALTYPE)[0];p.push({Seq:"1",Seqno:"1",Ind_sector:"J",Matl_type:u.MATERIALTYPE,Matl_group:u.MATERIALGROUP,Old_mat_no:u.OLDMATERIALNO,Base_uom:u.BASEUOM,Batch_mgmt:"X",Net_weight:u.NETWT,Unit_of_wt:u.WTUOM,Po_unit:u.ORDERUOM,Pur_valkey:u.PURCHVALUEKEY,Plant:i.getView().getModel("matPlantClass").getData().results[0].PLANTCD,Mrp_type:M.Dismm,Period_ind:"M",Proc_type:"F",Availcheck:"KP",Profit_ctr:i.getView().getModel("matPlantClass").getData().results[0].PROFITCTR,Val_area:i.getView().getModel("matPlantClass").getData().results[0].PLANTCD,Price_ctrl:u.MATERIALGROUP==="ACC"||u.MATERIALGROUP==="FAB"?"V":"",Moving_pr:"0",Price_unit:"1",Val_class:M.Bklas});b={Seq:"1",Mattyp:u.MATERIALTYPE,Gmc:u.GMC,Descen:c,Desczh:h,Processcd:u.PROCESSCODE,Cusmatno:u.CUSMATCODE,Grswt:u.GROSSWT,Volume:u.VOLUME,Voluom:u.VOLUMEUOM,Length:u.LENGTH+"",Width:u.WIDTH+"",Height:u.HEIGHT+"",Dimuom:u.DIMENSIONUOM,Remarks:"",MatAttribParamSet:m,MatImportParamSet:p,RetMsgSet:[{Seq:"1"}]};o+=await i.saveMM(e,b)}if(i._bErrorCreateMM==false){this._oViewSettingsDialog["zuimatmaster.view.fragments.MaterialTypeClassDialog"].close();this.getMain();this.byId("smartFilterBar").setVisible(true);this.byId("splitterHdr").setProperty("size","50%");this.byId("splitterDtl").setProperty("size","50%");this.byId("btnAddHdr").setVisible(true);this.byId("btnEditHdr").setVisible(true);this.byId("btnAddRowHdr").setVisible(false);this.byId("btnRemoveRowHdr").setVisible(false);this.byId("btnSaveHdr").setVisible(false);this.byId("btnCancelHdr").setVisible(false);this.byId("btnDeleteHdr").setVisible(true);this.byId("btnFullScreenHdr").setVisible(true);this.setRowReadMode();this._dataMode="READ"}s.information(o);a.closeProcessingDialog(f)}},saveMM:function(e,t){var s=this.getOwnerComponent().getModel("ZGW_3DERP_MATERIAL_SRV");var a="";s.setHeaders({sbu:e});var r=new Promise((e,r)=>{console.log("pParam",t);s.create("/MaterialHdrSet",t,{method:"POST",async:false,success:function(t,s){if(t.RetMsgSet.results[0].Type!="S"&&f._bErrorCreateMM==false)f._bErrorCreateMM=true;a+=t.RetMsgSet.results[0].Message+"\n";e(a)},error:function(){}})});return r},onCloseConfirmDialog:function(e){if(this._ConfirmDialog.getModel().getData().Action==="update-cancel"){if(this._sActiveTable==="headerTab"){this.byId("smartFilterBar").setVisible(true);f.byId("btnAddHdr").setVisible(true);f.byId("btnEditHdr").setVisible(true);f.byId("btnAddRowHdr").setVisible(false);f.byId("btnRemoveRowHdr").setVisible(false);f.byId("btnSaveHdr").setVisible(false);f.byId("btnCancelHdr").setVisible(false);f.byId("btnDeleteHdr").setVisible(true);f.byId("btnRefreshHdr").setVisible(true);f.byId("btnFullScreenHdr").setVisible(true)}this.byId(this._sActiveTable).getModel().setProperty("/rows",this._aDataBeforeChange);this.byId(this._sActiveTable).bindRows("/rows");if(this._aColFilters.length>0){this.setColumnFilters(this._sActiveTable)}if(this._aColSorters.length>0){this.setColumnSorters(this._sActiveTable)}this.setRowReadMode();this._dataMode="READ";this.setActiveRowHighlightByTableId(this._sActiveTable)}this._ConfirmDialog.close()},onCancel:function(e){var t=e.getSource().oParent.oParent;var s=t.sId.split("--")[t.sId.split("--").length-1];this._sActiveTable=s;this.byId("smartFilterBar").setVisible(true);this.cancelData()},cancelData(){if(this._dataMode==="NEW"||this._dataMode==="EDIT"){var e=false;if(this._sActiveTable==="headerTab")e=this._bHdrChanged;if(e){var s={Action:"update-cancel",Text:this.getView().getModel("ddtext").getData()["CONFIRM_DISREGARD_CHANGE"]};var a=new t;a.setData(s);if(!this._ConfirmDialog){this._ConfirmDialog=sap.ui.xmlfragment("zuimatmaster.view.fragments.dialog.ConfirmDialog",this);this._ConfirmDialog.setModel(a);this.getView().addDependent(this._ConfirmDialog)}else this._ConfirmDialog.setModel(a);this._ConfirmDialog.open()}else{if(this._sActiveTable==="headerTab"){f.byId("btnAddHdr").setVisible(true);f.byId("btnEditHdr").setVisible(true);f.byId("btnAddRowHdr").setVisible(false);f.byId("btnRemoveRowHdr").setVisible(false);f.byId("btnSaveHdr").setVisible(false);f.byId("btnCancelHdr").setVisible(false);f.byId("btnDeleteHdr").setVisible(true);f.byId("btnRefreshHdr").setVisible(true);f.byId("btnFullScreenHdr").setVisible(true)}this.byId(this._sActiveTable).getModel().setProperty("/rows",this._aDataBeforeChange);this.byId(this._sActiveTable).bindRows("/rows");if(this._aColFilters.length>0){this.setColumnFilters(this._sActiveTable)}if(this._aColSorters.length>0){this.setColumnSorters(this._sActiveTable)}this.byId("splitterHdr").setProperty("size","50%");this.byId("splitterDtl").setProperty("size","50%");this.setRowReadMode();this._dataMode="READ"}}},onEdit(){if(this._dataMode==="READ"){if(this._sActiveTable==="headerTab"){this.onEditMain()}}},onEditMain(){var e=this.getOwnerComponent().getModel();var t="/MaterialSet";var a=this;var r=this.byId("headerTab");var i=r.getSelectedIndices();var l=[];var o=r.getModel().getData().rows;var n=[];var d=false,g=false;var u=0;if(i.length>0){i.forEach(e=>{l.push(r.getBinding("rows").aIndices[e])});i=l;i.forEach((r,l)=>{e.read(t,{urlParameters:{$filter:"MATERIALNO eq '"+o.at(r).MATERIALNO+"'"},success:function(e,t){u++;console.log(e.results);if(e.results.length>0){g=true;o.at(r).WMAT=true}else{o.at(r).WMAT=false}n.push(o.at(r));if(i.length===u){if(!a._GMCDescZHAuth&&n.filter(e=>e.WMAT===false).length===0){s.information(a.getView().getModel("ddtext").getData()["INFO_GMC_NO_EDIT"])}else{a.byId("btnAddGMC").setVisible(false);a.byId("btnEditGMC").setVisible(false);a.byId("btnSaveGMC").setVisible(true);a.byId("btnCancelGMC").setVisible(true);a.byId("btnDeleteGMC").setVisible(false);a.byId("btnRefreshGMC").setVisible(false);a.byId("btnSortGMC").setVisible(false);a.byId("btnExitFullScreenHdr").setVisible(false);a.byId("searchFieldGMC").setVisible(false);a.byId("btnExitFullScreenHdr").setVisible(false);a.byId("btnTabLayoutGMC").setVisible(false);a.byId("btnDataWrapGMC").setVisible(false);a.byId("cboxSBU").setEnabled(false);a.setScreenSize("header",true,"100%","0%");a._oDataBeforeChange=c.extend(true,{},a.getView().getModel("gmc").getData());a.getView().getModel("gmc").setProperty("/results",n);a.setRowEditMode("gmc");a.getView().getModel("ui").setProperty("/dataMode","EDIT");a.getView().getModel("ui").setProperty("/updTable","gmc");a._isGMCEdited=false;if(sap.ushell.Container!==undefined){sap.ushell.Container.setDirtyFlag(false)}}}},error:function(e){u++}})})}else{s.information(this.getView().getModel("ddtext").getData()["INFO_NO_SEL_RECORD_TO_PROC"])}},onCancelConfirmDialog:function(e){var t=e.getSource().oParent.oParent;var s=t.sId.split("--")[t.sId.split("--").length-1];this._sActiveTable=s;this.byId("smartFilterBar").setVisible(true);this._ConfirmDialog.close();this.cancelData()},onCellClick:function(e){if(e.getParameters().rowBindingContext){var t=e.getSource();var s=e.getParameters().rowBindingContext.sPath;var r=t.getModel().getProperty(s+"/MATERIALNO");if(t.getId().indexOf("headerTab")>=0){a.openLoadingDialog(f);f.getView().getModel("ui").setProperty("/acitveMatno",r);f.getAttributes(r);f.getBatch(r);f.getCustomInfo(r);f.getPlant(r);f.getUnit(r);if(this._dataMode==="READ")this._sActiveTable="headerTab"}else{if(this._dataMode==="READ")this._sActiveTable="detailTab"}t.getModel().getData().rows.forEach(e=>e.ACTIVE="");t.getModel().setProperty(s+"/ACTIVE","X");t.getRows().forEach(e=>{if(e.getBindingContext()&&e.getBindingContext().sPath.replace("/rows/","")===s.replace("/rows/","")){e.addStyleClass("activeRow")}else e.removeStyleClass("activeRow")})}},onExtendMaterial:async function(){var e=this;var s=this.getOwnerComponent().getModel();var a=f.getView().getModel("ui").getProperty("/acitveMatno");var r="VER";var i={};var l=new t;var o=new t;var n=[];var d=[];var g=[];var u=[];await new Promise((e,t)=>{s.read("/ExtendMaterialChkSet",{urlParameters:{$filter:"MATNO eq '"+a+"'"},success:async function(t,s){console.log("ExtMatChk",t.results);n=t.results;e()},error:function(){e()}})});await new Promise((e,t)=>{s.read("/ExtendMaterialSet",{urlParameters:{$filter:"SBU eq '"+r+"'"},success:async function(t,s){console.log("ExtMat",t.results);d=t.results;e()},error:function(){e()}})});await new Promise((e,t)=>{d.filter(function(t,s){n.forEach(e=>{if(t.PLANTCD===e.PLANTCD){delete d[s]}});e()});d.forEach(e=>{u.push(e)});e()});l.setData(u);e.getView().setModel(l,"mmExtendTblData");console.log("mmExtendTblData",f.getView().getModel("mmExtendTblData").getData());i={Title:"Extend Material"};o.setData(i);e.onExtendMaterialDialog=sap.ui.xmlfragment(e.getView().getId(),"zuimatmaster.view.fragments.dialog.MMExtendDialog",e);e.onExtendMaterialDialog.setModel(o);e.getView().addDependent(e.onExtendMaterialDialog);var h=c.sap.getModulePath("zuimatmaster","/model/columns.json");var b=new t;await b.loadData(h);var T=b.getData();this._oModelColumns=b.getData();var p=new Promise((e,t)=>{e(this.getDynamicColumns("MMExtend","ZDV_MMEXTEND","mmExtendTbl",T))});await p;f.byId("mmExtendTbl").getModel().setProperty("/rows",f.getView().getModel("mmExtendTblData").getData());f.byId("mmExtendTbl").bindRows("/rows");e.onExtendMaterialDialog.open()},onCancelExtendMM:async function(){this.onExtendMaterialDialog.destroy(true)},onSaveExtendMaterial:async function(){var e=this;var t=this.getOwnerComponent().getModel();var r=this.getOwnerComponent().getModel("ZGW_3DERP_MATERIAL_SRV");var i=e.getView().getModel("ui").getProperty("/acitveMatno");var l=this.byId("mmExtendTbl");var o=l.getSelectedIndices();var n=[];var d=l.getModel().getData().rows;var g=false;var u="";var c=0;var h={};var b={};var T=[];if(o.length>0){a.openLoadingDialog(this);o.forEach(e=>{n.push(l.getBinding("rows").aIndices[e])});o=n;for(var p in o){await new Promise((e,s)=>{c++;t.read("/ExtendMaterialVldMatChkSet",{urlParameters:{$filter:"MATNO eq '"+i+"'"},success:async function(t,s){if(t.results.length>0){g=true;e(u=t.results[0].PLANTCD)}e()},error:function(){e()}})});if(g){b={Subrc:0};T.push({Row:0,Matnr:i,WerksFrom:u,WerksTo:d.at(p).PLANTCD})}if(o.length===c){h=b;h["N_IMatPlant"]=T;h["N_EMatPlant"]=[];h["N_Messtab"]=[];if(T.length>0){await new Promise((e,t)=>{r.create("/MatExtendSet",h,{method:"POST",success:function(t,a){const r=t.N_Messtab.results.length-1;if(t.N_Messtab.results[r].Type==="S"){s.information(t.N_Messtab.results[0].Message)}else if(t.N_Messtab.results[r].Type==="E"){s.error(Object.values(t.N_Messtab.results).pop().Message)}e()},error:function(t){e()}})})}else{s.error("No valid Purchasing Plant found.")}}}a.closeLoadingDialog(f);this.onExtendMaterialDialog.destroy(true);this.getPlant(i)}else{s.warning("No Selected Record!")}},formatValueHelp:function(e,t,s,a,r){if(this.getView().getModel(t)===undefined){return e}var i=this.getView().getModel(t).getData().filter(t=>t[s]===e);if(i&&i.length>0){if(r==="Value"){return i[0][a]}else if(r==="ValueKey"){return i[0][a]+" ("+e+")"}else if(r==="KeyValue"){return e+" ("+i[0][a]+")"}else{return e}}else return e},onKeyUp(e){if((e.key==="ArrowUp"||e.key==="ArrowDown")&&e.srcControl.sParentAggregationName==="rows"){var t=this.byId(e.srcControl.sId).oParent;if(this.byId(e.srcControl.sId).getBindingContext()){var s=this.byId(e.srcControl.sId).getBindingContext().sPath;var a=t.getModel().getProperty(s+"/MATERIALNO");t.getModel().getData().rows.forEach(e=>e.ACTIVE="");t.getModel().setProperty(s+"/ACTIVE","X");f.getView().getModel("ui").setProperty("/acitveMatno",a);t.getRows().forEach(e=>{if(e.getBindingContext()&&e.getBindingContext().sPath.replace("/rows/","")===s.replace("/rows/","")){e.addStyleClass("activeRow")}else e.removeStyleClass("activeRow")});f.getAttributes(a);f.getBatch(a);f.getCustomInfo(a);f.getPlant(a);f.getUnit(a)}if(t.getId().indexOf("headerTab")>=0){var r=this.byId("detailTab");var i=r.getColumns();for(var l=0,o=i.length;l<o;l++){if(i[l].getSorted()){i[l].setSorted(false)}}}}else if(e.key==="Enter"&&e.srcControl.sParentAggregationName==="cells"){if(this._dataMode==="NEW")this.onAddNewRow()}},onDelete:function(e){var t=e.getSource().oParent.oParent;var s=t.sId.split("--")[t.sId.split("--").length-1];this._sActiveTable=s;this.deleteData()},deleteData(){if(this._dataMode==="READ"){var e=this.byId(this._sActiveTable);var t=e.getSelectedIndices();var r=[];var i=e.getModel().getData().rows;if(t.length===0){s.information(this.getView().getModel("ddtext").getData()["INFO_NO_SEL_RECORD_TO_PROC"])}else{if(t.length>1){this.byId("headerTab").clearSelection();s.information("Please select one record only.")}else{t.forEach(t=>{r.push(e.getBinding("rows").aIndices[t])});t=r;s.confirm("Proceed to delete record?",{actions:["Yes","No"],onClose:function(e){if(e==="Yes"){a.openProcessingDialog(f,"Processing...");if(f.byId(f._sActiveTable).getBinding("rows").aFilters.length>0){f._aColFilters=f.byId(f._sActiveTable).getBinding("rows").aFilters}if(f.byId(f._sActiveTable).getBinding("rows").aSorters.length>0){f._aColSorters=f.byId(f._sActiveTable).getBinding("rows").aSorters}t.forEach(e=>{var t=f.getOwnerComponent().getModel();var s="/MaterialSet('"+i.at(e)["MATERIALNO"]+"')";var r={Deleted:"X"};t.update(s,r,{method:"PUT",success:function(t){f.getMain();a.closeProcessingDialog(f);sap.m.MessageBox.information("Material No : "+i.at(e)["MATERIALNO"]+" has been successfully deleted!")},error:function(e,t){a.closeProcessingDialog(f);sap.m.MessageBox.warning(e.message)}})})}}})}}}}})});