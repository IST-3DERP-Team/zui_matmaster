sap.ui.define(["sap/ui/core/mvc/Controller","sap/ui/model/json/JSONModel","sap/m/MessageBox","../js/Common","sap/ui/model/Filter","sap/ui/model/FilterOperator","sap/ui/core/routing/HashChanger","sap/m/Token","sap/m/ColumnListItem","sap/m/Label","../js/TableValueHelp","../js/TableFilter","jquery.sap.global","sap/ui/Device"],function(e,t,a,s,i,r,l,o,n,d,u,g,h,c){"use strict";var p;var f=sap.ui.core.format.DateFormat.getDateInstance({pattern:"MM/dd/yyyy"});var m=sap.ui.core.format.DateFormat.getDateInstance({pattern:"YYYY-MM-dd"});var b=sap.ui.core.format.DateFormat.getDateInstance({pattern:"yyyyMMdd"});var T=sap.ui.core.format.DateFormat.getTimeInstance({pattern:"KK:mm:ss a"});var M=new Date(0).getTimezoneOffset()*60*1e3;return e.extend("zuimatmaster.controller.Main",{onInit:function(){p=this;this._aColumns={};this._aDataBeforeChange=[];this._validationErrors=[];this._bHdrChanged=false;this._bDtlChanged=false;this._dataMode="READ";this._aColFilters=[];this._aColSorters=[];this._aMultiFiltersBeforeChange=[];this._aFilterableColumns={};this._oViewSettingsDialog={};this._sActiveTable="headerTab";this._oModel=this.getOwnerComponent().getModel();this._tableValueHelp=u;this._tableFilter=g;this._colFilters={};this._oTableLayout={headerTab:{type:"MMHDR",tabname:"ZDVZERPMATL"},attributesTab:{type:"MMATTRIB",tabname:"ZERP_MATATTRIB"},batchTab:{type:"MMBATCH",tabname:"ZERP_MATBATCH"},customInfoTab:{type:"MMCUSTOMINFO",tabname:"ZERP_MATCUSINFO"},plantTab:{type:"MMPLANT",tabname:"MARC"},unitTab:{type:"MMUNIT",tabname:"ZDV_MAT_UNIT"}};this.setSmartFilterModel();var e=this.getOwnerComponent().getModel("ZVB_3DERP_MM_FILTERS_CDS");e.read("/ZVB_3DERP_SBU_SH",{success:function(e,t){if(e.results.length===1){that.getView().getModel("ui").setProperty("/sbu",e.results[0].SBU)}else{}},error:function(e){}});this.getView().setModel(new t({acitveMatno:"",smartfiltergf:0,splittergf:.94,fullscreen:{header:false,detail:false},splitter:{header:"50%",detail:"50%"},dataWrap:{headerTab:false,attributesTab:false,batchTab:false,customInfoTab:false,plantTab:false,unitTab:false}}),"ui");this._counts={header:0,attributes:0,batch:0,customInfo:0,plant:0,unit:0};this.getView().setModel(new t(this._counts),"counts");this.byId("headerTab").setModel(new t({columns:[],rows:[]}));this.byId("attributesTab").setModel(new t({columns:[],rows:[]}));this.byId("batchTab").setModel(new t({columns:[],rows:[]}));this.byId("customInfoTab").setModel(new t({columns:[],rows:[]}));this.byId("plantTab").setModel(new t({columns:[],rows:[]}));this.byId("unitTab").setModel(new t({columns:[],rows:[]}));var a=[],s={};var e=this.getOwnerComponent().getModel("ZGW_3DERP_COMMON_SRV");a.push({CODE:"SBU"});a.push({CODE:"INFO_NO_RECORD_TO_PROC"});a.push({CODE:"INFO_NO_SEL_RECORD_TO_PROC"});a.push({CODE:"INFO_NO_LAYOUT"});a.push({CODE:"INFO_LAYOUT_SAVE"});a.push({CODE:"INFO_INPUT_REQD_FIELDS"});a.push({CODE:"CONFIRM_DISREGARD_CHANGE"});a.push({CODE:"INFO_SEL_RECORD_TO_DELETE"});a.push({CODE:"INFO_DATA_DELETED"});a.push({CODE:"CONF_DELETE_RECORDS"});a.push({CODE:"INFO_ERROR"});a.push({CODE:"INFO_NO_DATA_SAVE"});a.push({CODE:"INFO_DATA_SAVE"});a.push({CODE:"INFO_NO_DATA_EDIT"});a.push({CODE:"INFO_CHECK_INVALID_ENTRIES"});a.push({CODE:"ADD"});a.push({CODE:"EDIT"});a.push({CODE:"ADDROW"});a.push({CODE:"REMOVEROW"});a.push({CODE:"SAVE"});a.push({CODE:"CANCEL"});a.push({CODE:"DELETE"});a.push({CODE:"REFRESH"});a.push({CODE:"COPY"});a.push({CODE:"HASGMC"});a.push({CODE:"INFO_INPUT_REQD_FIELDS"});a.push({CODE:"INFO_NO_DATA_MODIFIED"});a.push({CODE:"INFO_DATA_COPIED"});a.push({CODE:"WRAP"});a.push({CODE:"UNWRAP"});e.create("/CaptionMsgSet",{CaptionMsgItems:a},{method:"POST",success:function(e,a){e.CaptionMsgItems.results.forEach(e=>{s[e.CODE]=e.TEXT});p.getView().setModel(new t(s),"ddtext")},error:function(e){}});var i={onkeyup:function(e){p.onKeyUp(e)},onAfterRendering:function(e){var t=e.srcControl;var a=t.sId.split("--")[t.sId.split("--").length-1];if(a.substr(a.length-3)==="Tab")p._tableRendered=a;else p._tableRendered="";p.onAfterTableRendering()},onclick:function(e){p.onTableClick(e)}};this.byId("headerTab").addEventDelegate(i);this.byId("attributesTab").addEventDelegate(i);this.byId("batchTab").addEventDelegate(i);this.byId("customInfoTab").addEventDelegate(i);this.byId("plantTab").addEventDelegate(i);this.byId("unitTab").addEventDelegate(i);this.getColumnProp();this.byId("headerTab").attachBrowserEvent("mousemove",function(e){});this._oModel.read("/MatTypeSHSet",{async:false,success:function(e){p.getView().setModel(new t(e.results),"MTYP_MODEL")},error:function(e){}});this._oModel.read("/MatGrpRscSet",{async:false,success:function(e){p.getView().setModel(new t(e.results),"MATERIALGRP_MODEL")},error:function(e){}});this._oModel.read("/UOMRscSet",{async:false,success:function(e){p.getView().setModel(new t(e.results),"BASEUOM_MODEL")},error:function(e){}});this._oModel.read("/WeightUnitSet",{async:false,success:function(e){p.getView().setModel(new t(e.results),"WTUOM_MODEL")},error:function(e){}});this._oModel.read("/VolumeUnitSet",{async:false,success:function(e){p.getView().setModel(new t(e.results),"VOLUOM_MODEL")},error:function(e){}});this._oModel.read("/ProcessRscSet",{async:false,success:function(e){p.getView().setModel(new t(e.results),"PROCESSCD_MODEL")},error:function(e){}});this._oModel.read("/DimensionUnitSet",{async:false,success:function(e){p.getView().setModel(new t(e.results),"DIMUOM_MODEL")},error:function(e){}});this._oModel.read("/PurValKeyRscSet",{async:false,success:function(e){p.getView().setModel(new t(e.results),"PURCHASEVALUE_MODEL")},error:function(e){}})},onSearch:function(){this.getMain()},setSmartFilterModel:function(){var e=this.getOwnerComponent().getModel("ZVB_3DERP_MM_FILTERS_CDS");var t=this.getView().byId("smartFilterBar");t.setModel(e)},getColumnProp:async function(){var e=h.sap.getModulePath("zuimatmaster","/model/columns.json");var a=new t;await a.loadData(e);var s=a.getData();this._oModelColumns=a.getData();setTimeout(()=>{this.getDynamicColumns("MMHDR","ZDVZERPMATL","headerTab",s)},100);setTimeout(()=>{this.getDynamicColumns("MMATTRIB","ZERP_MATATTRIB","attributesTab",s)},100);setTimeout(()=>{this.getDynamicColumns("MMBATCH","ZERP_MATBATCH","batchTab",s)},100);setTimeout(()=>{this.getDynamicColumns("MMCUSTOMINFO","ZERP_MATCUSINFO","customInfoTab",s)},100);setTimeout(()=>{this.getDynamicColumns("MMPLANT","MARC","plantTab",s)},100);setTimeout(()=>{this.getDynamicColumns("MMUNIT","ZDV_MAT_UNIT","unitTab",s)},100)},getDynamicColumns(e,a,s,i){var r=this;var l=e;var o=a;var n=s;var d=i;var u=this.getOwnerComponent().getModel("ZGW_3DERP_COMMON_SRV");var g="VER";u.setHeaders({sbu:g,type:l,tabname:o});u.read("/ColumnsSet",{success:function(e,a){if(e.results.length>0){console.log("columnset",e.results);if(d[n.replace("Tab","")]!==undefined){e.results.forEach(e=>{d[n.replace("Tab","")].filter(t=>t.ColumnName===e.ColumnName).forEach(t=>{e.ValueHelp=t.ValueHelp;e.TextFormatMode=t.TextFormatMode})})}r._aColumns[n.replace("Tab","")]=e.results;r.setTableColumns(n,e.results);var s=r.getView().getModel("ddtext").getData();e.results.forEach(e=>{s[e.ColumnName]=e.ColumnLabel});r.getView().setModel(new t(s),"ddtext")}},error:function(e){}})},setTableColumns(e,t){var a=e;var s=t;var i=this.getView().byId(a);i.getModel().setProperty("/columns",s);i.bindColumns("/columns",function(e,t){var s=t.getObject().ColumnName;var i=t.getObject().ColumnLabel;var r=t.getObject().ColumnWidth;var l=t.getObject().Visible;var o=t.getObject().Sorted;var n=t.getObject().SortOrder;var d=t.getObject().DataType;if(r===0)r=100;var u=new sap.m.Text({wrapping:false});var g=p._aColumns[a.replace("Tab","")].filter(e=>e.ColumnName===s);if(g&&g.length>0&&g[0].ValueHelp&&g[0].ValueHelp["items"].text&&g[0].ValueHelp["items"].value!==g[0].ValueHelp["items"].text&&g[0].TextFormatMode&&g[0].TextFormatMode!=="Key"){u.bindText({parts:[{path:s}],formatter:function(e){var t=p.getView().getModel(g[0].ValueHelp["items"].path).getData().filter(t=>t[g[0].ValueHelp["items"].value]===e);if(t&&t.length>0){if(g[0].TextFormatMode==="Value"){return t[0][g[0].ValueHelp["items"].text]}else if(g[0].TextFormatMode==="ValueKey"){return t[0][g[0].ValueHelp["items"].text]+" ("+e+")"}else if(g[0].TextFormatMode==="KeyValue"){return e+" ("+t[0][g[0].ValueHelp["items"].text]+")"}}else return e}})}else{u.bindText({parts:[{path:s}]})}if(a==="headerTab"){if(s==="HASGMC"){d="BOOLEAN"}else if(s==="UEBTK"){d="BOOLEAN"}}else if(a==="plantTab"){if(s==="LVORM"){d="BOOLEAN"}}return new sap.ui.table.Column({id:a.replace("Tab","")+"Col"+s,label:new sap.m.Text({text:i}),template:d==="BOOLEAN"?new sap.m.CheckBox({selected:"{"+s+"}",editable:false}):u,width:r+"px",sortProperty:s,autoResizable:true,visible:l,sorted:o,hAlign:d==="NUMBER"?"End":d==="BOOLEAN"?"Center":"Begin",sortOrder:o===true?n:"Ascending"})});i.attachSort(function(e){var t=e.getParameter("column").getSortProperty();var a=false;i.getColumns().forEach(e=>{if(e.getSorted()){e.setSorted(false)}});e.getParameter("column").setSorted(true);if(e.getParameter("sortOrder")==="Descending"){a=true;e.getParameter("column").setSortOrder("Descending")}else{e.getParameter("column").setSortOrder("Ascending")}var r=new sap.ui.model.Sorter(t,a);var l=s.filter(t=>t.ColumnName===e.getParameter("column").getProperty("sortProperty"));var o=l[0].DataType;if(o==="DATETIME"){r.fnCompare=function(e,t){var a=new Date(e);var s=new Date(t);if(s===null){return-1}if(a===null){return 1}if(a<s){return-1}if(a>s){return 1}return 0}}else if(o==="NUMBER"){r.fnCompare=function(e,t){var a=+e;var s=+t;if(s===null){return-1}if(a===null){return 1}if(a<s){return-1}if(a>s){return 1}return 0}}i.getBinding("rows").sort(r);e.preventDefault()});g.updateColumnMenu(a,this)},onTableClick(e){var t=e.srcControl;var a=t.sId.split("--")[t.sId.split("--").length-1];while(a.substr(a.length-3)!=="Tab"){t=t.oParent;a=t.sId.split("--")[t.sId.split("--").length-1]}if(this._dataMode==="READ")this._sActiveTable=a},onSaveTableLayout:function(e){this._sActiveTable=e.getSource().data("TableId");var t=this.byId(this._sActiveTable);var s=t.getColumns();var i="VER";var r=this;var l=1;var o={SBU:i,TYPE:this._oTableLayout[this._sActiveTable].type,TABNAME:this._oTableLayout[this._sActiveTable].tabname,TableLayoutToItems:[]};s.forEach(e=>{o.TableLayoutToItems.push({COLUMNNAME:e.mProperties.sortProperty,ORDER:l.toString(),SORTED:e.mProperties.sorted,SORTORDER:e.mProperties.sortOrder,SORTSEQ:"1",VISIBLE:e.mProperties.visible,WIDTH:e.mProperties.width.replace("px","")});l++});console.log(o);var n=this.getOwnerComponent().getModel("ZGW_3DERP_COMMON_SRV");n.create("/TableLayoutSet",o,{method:"POST",success:function(e,t){a.information(r.getView().getModel("ddtext").getData()["INFO_LAYOUT_SAVE"])},error:function(e){a.error(e)}})},onAfterTableRendering:function(e){if(this._tableRendered!==""){this.setActiveRowHighlightByTableId(this._tableRendered);this._tableRendered=""}},setActiveRowHighlightByTableId(e){var t=this.byId(e);setTimeout(()=>{var e=t.getModel().getData().rows.findIndex(e=>e.ACTIVE==="X");t.getRows().forEach(t=>{if(t.getBindingContext()&&+t.getBindingContext().sPath.replace("/rows/","")===e){t.addStyleClass("activeRow")}else t.removeStyleClass("activeRow")})},10)},getMain(){s.openLoadingDialog(this);var e=this.getOwnerComponent().getModel();var t=this.getView().byId("smartFilterBar").getFilters();console.log("aFilters",t);var a=this;var i="VER";e.read("/MaterialSet",{filters:t,success:function(e,t){if(e.results.length>0){e.results.sort((e,t)=>new Date(t.CREATEDDT)-new Date(e.CREATEDDT)||parseInt(t.MATERIALNO)-parseInt(e.MATERIALNO))}e.results.forEach((e,t)=>{e.HASGMC=e.HASGMC==="X"?true:false;if(e.CREATEDDT!==null)e.CREATEDDT=f.format(new Date(e.CREATEDDT));if(e.UPDATEDDATE!==null)e.UPDATEDDATE=f.format(new Date(e.UPDATEDDATE));if(t===0){e.ACTIVE="X";p.getView().getModel("ui").setProperty("/acitveMatno",e.MATERIALNO);p.getAttributes(e.MATERIALNO);p.getBatch(e.MATERIALNO);p.getCustomInfo(e.MATERIALNO);p.getPlant(e.MATERIALNO);p.getUnit(e.MATERIALNO)}else{e.ACTIVE=""}});p.byId("headerTab").getModel().setProperty("/rows",e.results);p.byId("headerTab").bindRows("/rows");p.getView().getModel("counts").setProperty("/header",e.results.length);s.closeLoadingDialog(p)},error:function(e){s.closeLoadingDialog(p)}})},getAttributes(e){var t=this.getOwnerComponent().getModel();var a="/MaterialAtrribSet";t.read(a,{urlParameters:{$filter:"MATNO eq '"+e+"'"},success:function(e,t){if(e.results.length>0){e.results.forEach(e=>{if(e.CREATEDDT!==null){e.CREATEDDT=f.format(new Date(e.CREATEDDT))}if(e.UPDATEDDT!==null){e.UPDATEDDT=f.format(new Date(e.UPDATEDDT))}})}p.byId("attributesTab").getModel().setProperty("/rows",e.results);p.byId("attributesTab").bindRows("/rows");p.getView().getModel("counts").setProperty("/attributes",e.results.length);s.closeLoadingDialog(p)},error:function(e){s.closeLoadingDialog(p)}})},getBatch(e){var t=this.getOwnerComponent().getModel();var a="/MaterialBatchSet";t.read(a,{urlParameters:{$filter:"MATNO eq '"+e+"'"},success:function(e,t){if(e.results.length>0){e.results.forEach(e=>{if(e.CREATEDDT!==null){e.CREATEDDT=f.format(new Date(e.CREATEDDT))}if(e.UPDATEDDT!==null){e.UPDATEDDT=f.format(new Date(e.UPDATEDDT))}})}p.byId("batchTab").getModel().setProperty("/rows",e.results);p.byId("batchTab").bindRows("/rows");p.getView().getModel("counts").setProperty("/batch",e.results.length);s.closeLoadingDialog(p)},error:function(e){s.closeLoadingDialog(p)}})},getCustomInfo(e){var t=this.getOwnerComponent().getModel();var a="/MaterialCusInfoSet";t.read(a,{urlParameters:{$filter:"MATNO eq '"+e+"'"},success:function(e,t){if(e.results.length>0){e.results.forEach(e=>{if(e.CREATEDDT!==null){e.CREATEDDT=f.format(new Date(e.CREATEDDT))}if(e.UPDATEDDT!==null){e.UPDATEDDT=f.format(new Date(e.UPDATEDDT))}})}p.byId("customInfoTab").getModel().setProperty("/rows",e.results);p.byId("customInfoTab").bindRows("/rows");p.getView().getModel("counts").setProperty("/customInfo",e.results.length);s.closeLoadingDialog(p)},error:function(e){s.closeLoadingDialog(p)}})},getPlant(e){var t=this.getOwnerComponent().getModel();var a="/PlantSet";t.read(a,{urlParameters:{$filter:"MATNR eq '"+e+"'"},success:function(e,t){if(e.results.length>0){e.results.forEach(e=>{if(e.CREATEDDT!==null){e.CREATEDDT=f.format(new Date(e.CREATEDDT))}if(e.UPDATEDDT!==null){e.UPDATEDDT=f.format(new Date(e.UPDATEDDT))}})}p.byId("plantTab").getModel().setProperty("/rows",e.results);p.byId("plantTab").bindRows("/rows");p.getView().getModel("counts").setProperty("/plant",e.results.length);s.closeLoadingDialog(p)},error:function(e){s.closeLoadingDialog(p)}})},getUnit(e){var t=this.getOwnerComponent().getModel();var a="/UnitMeasureSet";t.read(a,{urlParameters:{$filter:"MATNO eq '"+e+"'"},success:function(e,t){p.byId("unitTab").getModel().setProperty("/rows",e.results);p.byId("unitTab").bindRows("/rows");p.getView().getModel("counts").setProperty("/unit",e.results.length);s.closeLoadingDialog(p)},error:function(e){s.closeLoadingDialog(p)}})},onColFilterClear:function(e){g.onColFilterClear(e,this)},onColFilterCancel:function(e){g.onColFilterCancel(e,this)},onColFilterConfirm:function(e){g.onColFilterConfirm(e,this)},onFilterItemPress:function(e){g.onFilterItemPress(e,this)},onFilterValuesSelectionChange:function(e){g.onFilterValuesSelectionChange(e,this)},onSearchFilterValue:function(e){g.onSearchFilterValue(e,this)},onCustomColFilterChange:function(e){g.onCustomColFilterChange(e,this)},onSetUseColFilter:function(e){g.onSetUseColFilter(e,this)},onRemoveColFilter:function(e){g.onRemoveColFilter(e,this)},onRefresh:function(e){var t=e.getSource().oParent.oParent;var a=t.sId.split("--")[t.sId.split("--").length-1];this._sActiveTable=a;this.refreshData()},refreshData(){if(this._dataMode==="READ"){this._aColFilters=this.byId(this._sActiveTable).getBinding("rows").aFilters;this._aColSorters=this.byId(this._sActiveTable).getBinding("rows").aSorters;var e=this.getView().getModel("ui").getProperty("/acitveMatno");s.openLoadingDialog(this);if(this._sActiveTable==="headerTab"){this.getMain()}else if(this._sActiveTable==="attributesTab"){this.getAttributes(e)}else if(this._sActiveTable==="batchTab"){this.getBatch(e)}else if(this._sActiveTable==="customInfoTab"){this.getCustomInfo(e)}else if(this._sActiveTable==="plantTab"){this.getPlant(e)}else if(this._sActiveTable==="unitTab"){this.getUnit(e)}}},onWrapText:function(e){this._sActiveTable=e.getSource().data("TableId");var t=this.getView().getModel("ui").getData().dataWrap[this._sActiveTable];this.byId(this._sActiveTable).getColumns().forEach(e=>{var a=e.getTemplate();if(a instanceof sap.m.Text){a.setWrapping(!t);e.setTemplate(a)}});this.getView().getModel("ui").setProperty("/dataWrap/"+[this._sActiveTable],!t)},onCreate:function(e){var t=e.getSource().oParent.oParent;var a=t.sId.split("--")[t.sId.split("--").length-1];this._sActiveTable=a;this.byId("splitterHdr").setProperty("size","100%");this.byId("splitterDtl").setProperty("size","0%");this.createData()},createData(){if(this._dataMode==="READ"){if(this._sActiveTable==="headerTab"){this.byId("btnAddHdr").setVisible(false);this.byId("btnEditHdr").setVisible(false);this.byId("btnDeleteHdr").setVisible(false);this.byId("btnRefreshHdr").setVisible(false);this.byId("btnAddRowHdr").setVisible(true);this.byId("btnRemoveRowHdr").setVisible(true);this.byId("btnSaveHdr").setVisible(true);this.byId("btnCancelHdr").setVisible(true);this.byId("btnFullScreenHdr").setVisible(false);this.byId("btnExitFullScreenHdr").setVisible(false);this.byId("smartFilterBar").setVisible(false)}var e=this.byId(this._sActiveTable);this._aDataBeforeChange=h.extend(true,[],e.getModel().getData().rows);this._validationErrors=[];if(e.getBinding("rows").aApplicationFilters.length>0){this._aMultiFiltersBeforeChange=this._aFilterableColumns["gmc"].filter(e=>e.value!=="");e.getBinding("rows").filter("","Application")}if(e.getBinding("rows").aFilters.length>0){this._aColFilters=h.extend(true,[],e.getBinding("rows").aFilters);e.getBinding("rows").aFilters=[]}if(e.getBinding("rows").aSorters.length>0){this._aColSorters=h.extend(true,[],e.getBinding("rows").aSorters)}var t=e.getColumns();for(var a=0,s=t.length;a<s;a++){var i=t[a].getFiltered();if(i){t[a].filter("")}}this.setRowCreateMode()}},setRowCreateMode(){var e=this.byId(this._sActiveTable);var t=[];var a={};e.getColumns().forEach((e,t)=>{var s="";var i=false;if(e.mAggregations.template.mBindingInfos.text!==undefined){s=e.mAggregations.template.mBindingInfos.text.parts[0].path}else if(e.mAggregations.template.mBindingInfos.selected!==undefined){s=e.mAggregations.template.mBindingInfos.selected.parts[0].path}else if(e.mAggregations.template.mBindingInfos.value!==undefined){s=e.mAggregations.template.mBindingInfos.value.parts[0].path}this._aColumns[this._sActiveTable.replace("Tab","")].filter(e=>e.ColumnName===s).forEach(t=>{if(t.Editable||t.Creatable){if(t.ValueHelp!==undefined)i=t.ValueHelp["show"];if(i){var r=false;var l=t.ValueHelp["SuggestionItems"].text;var o=t.ValueHelp["SuggestionItems"].additionalText!==undefined?t.ValueHelp["SuggestionItems"].additionalText:"";var n="Key";if(t.TextFormatMode&&t.TextFormatMode!==""&&t.TextFormatMode!=="Key"&&t.ValueHelp["items"].value!==t.ValueHelp["items"].text){n=t.TextFormatMode;r=true;if(t.ValueHelp["SuggestionItems"].additionalText&&t.ValueHelp["SuggestionItems"].text!==t.ValueHelp["SuggestionItems"].additionalText){if(n==="ValueKey"||n==="Value"){l=t.ValueHelp["SuggestionItems"].additionalText;o=t.ValueHelp["SuggestionItems"].text}}}var d=new sap.m.Input({type:"Text",showValueHelp:true,valueHelpRequest:u.handleTableValueHelp.bind(this),showSuggestion:true,maxSuggestionWidth:t.ValueHelp["SuggestionItems"]?.additionalText?t.ValueHelp["SuggestionItems"].maxSuggestionWidth:"1px",suggestionItems:{path:t.ValueHelp["SuggestionItems"].path,length:1e4,template:new sap.ui.core.ListItem({key:t.ValueHelp["SuggestionItems"].text,text:l,additionalText:o}),templateShareable:false},change:this.handleValueHelpChange.bind(this)});if(r){d.setProperty("textFormatMode",n);d.bindValue({parts:[{path:s},{value:t.ValueHelp?.items?.path},{value:t.ValueHelp?.items?.value},{value:t.ValueHelp?.items?.text},{value:n}],formatter:this.formatValueHelp.bind(this)})}else{d.bindValue({parts:[{path:s}]})}e.setTemplate(d)}else if(t.DataType==="DATETIME"){if(this._sActiveTable==="costHdrTab"&&s==="CSDATE"){e.setTemplate(new sap.m.DatePicker({value:"{path: '"+t.ColumnName+"', mandatory: '"+t.Mandatory+"'}",displayFormat:"MM/dd/yyyy",valueFormat:"MM/dd/yyyy",change:this.onInputLiveChange.bind(this),enabled:{path:"COSTSTATUS",formatter:function(e){if(e==="REL"){return false}else{return true}}}}))}else{e.setTemplate(new sap.m.DatePicker({value:"{path: '"+t.ColumnName+"', mandatory: '"+t.Mandatory+"'}",displayFormat:"MM/dd/yyyy",valueFormat:"MM/dd/yyyy",change:this.onInputLiveChange.bind(this)}))}}else if(t.DataType==="NUMBER"){e.setTemplate(new sap.m.Input({type:sap.m.InputType.Number,textAlign:sap.ui.core.TextAlign.Right,value:"{path:'"+s+"', formatOptions:{ minFractionDigits:"+t.Decimal+", maxFractionDigits:"+t.Decimal+" }, constraints:{ precision:"+t.Length+", scale:"+t.Decimal+" }}",liveChange:this.onNumberLiveChange.bind(this)}))}else if(t.DataType==="BOOLEAN"){e.setTemplate(new sap.m.CheckBox({selected:"{"+s+"}",editable:true}))}else{if(this._sActiveTable==="ioMatListTab"&&s==="MATDESC1"){e.setTemplate(new sap.m.Input({type:"Text",value:"{"+s+"}",maxLength:t.Length,change:this.onInputLiveChange.bind(this),enabled:{path:"MATNO",formatter:function(e){if(e!==""){return false}else{return true}}}}))}else if(this._sActiveTable==="costHdrTab"&&s==="VERDESC"){e.setTemplate(new sap.m.Input({type:"Text",value:"{"+s+"}",maxLength:t.Length,change:this.onInputLiveChange.bind(this),enabled:{path:"COSTSTATUS",formatter:function(e){if(e==="REL"){return false}else{return true}}}}))}else{e.setTemplate(new sap.m.Input({type:"Text",value:"{"+s+"}",maxLength:t.Length,change:this.onInputLiveChange.bind(this)}))}}if(t.Mandatory){e.getLabel().addStyleClass("sapMLabelRequired")}if(t.DataType==="STRING")a[s]="";else if(t.DataType==="NUMBER")a[s]=0;else if(t.DataType==="BOOLEAN")a[s]=false}})});a["NEW"]=true;t=this.byId(this._sActiveTable).getModel().getProperty("/rows").filter(e=>e.NEW===true);t.push(a);this.byId(this._sActiveTable).getModel().setProperty("/rows",t);this.byId(this._sActiveTable).bindRows("/rows");this._dataMode="NEW";e.focus()},setRowEditMode(e){var t=this.byId(e+"Tab");var a=this;var s={onkeydown:function(e){a.onInputKeyDown(e)},onclick:function(t){if(e==="attributes"){a.onInputFocus(t)}}};t.getColumns().forEach((e,t)=>{var a="";var s=false;if(e.mAggregations.template.mBindingInfos.text!==undefined){a=e.mAggregations.template.mBindingInfos.text.parts[0].path}else if(e.mAggregations.template.mBindingInfos.selected!==undefined){a=e.mAggregations.template.mBindingInfos.selected.parts[0].path}else if(e.mAggregations.template.mBindingInfos.value!==undefined){a=e.mAggregations.template.mBindingInfos.value.parts[0].path}this._aColumns[this._sActiveTable.replace("Tab","")].filter(e=>e.ColumnName===a).forEach(t=>{if(t.Editable||t.Creatable){if(t.ValueHelp!==undefined)s=t.ValueHelp["show"];if(s){var i=false;var r=t.ValueHelp["SuggestionItems"].text;var l=t.ValueHelp["SuggestionItems"].additionalText!==undefined?t.ValueHelp["SuggestionItems"].additionalText:"";var o="Key";if(t.TextFormatMode&&t.TextFormatMode!==""&&t.TextFormatMode!=="Key"&&t.ValueHelp["items"].value!==t.ValueHelp["items"].text){o=t.TextFormatMode;i=true;if(t.ValueHelp["SuggestionItems"].additionalText&&t.ValueHelp["SuggestionItems"].text!==t.ValueHelp["SuggestionItems"].additionalText){if(o==="ValueKey"||o==="Value"){r=t.ValueHelp["SuggestionItems"].additionalText;l=t.ValueHelp["SuggestionItems"].text}}}var n=new sap.m.Input({type:"Text",showValueHelp:true,valueHelpRequest:u.handleTableValueHelp.bind(this),showSuggestion:true,maxSuggestionWidth:t.ValueHelp["SuggestionItems"]?.additionalText?t.ValueHelp["SuggestionItems"].maxSuggestionWidth:"1px",suggestionItems:{path:t.ValueHelp["SuggestionItems"].path,length:1e4,template:new sap.ui.core.ListItem({key:t.ValueHelp["SuggestionItems"].text,text:r,additionalText:l}),templateShareable:false},change:this.handleValueHelpChange.bind(this)});if(i){n.setProperty("textFormatMode",o);n.bindValue({parts:[{path:a},{value:t.ValueHelp?.items?.path},{value:t.ValueHelp?.items?.value},{value:t.ValueHelp?.items?.text},{value:o}],formatter:this.formatValueHelp.bind(this)})}else{n.bindValue({parts:[{path:a}]})}e.setTemplate(n)}else if(t.DataType==="DATETIME"){if(this._sActiveTable==="costHdrTab"&&a==="CSDATE"){e.setTemplate(new sap.m.DatePicker({value:"{path: '"+t.ColumnName+"', mandatory: '"+t.Mandatory+"'}",displayFormat:"MM/dd/yyyy",valueFormat:"MM/dd/yyyy",change:this.onInputLiveChange.bind(this),enabled:{path:"COSTSTATUS",formatter:function(e){if(e==="REL"){return false}else{return true}}}}))}else{e.setTemplate(new sap.m.DatePicker({value:"{path: '"+t.ColumnName+"', mandatory: '"+t.Mandatory+"'}",displayFormat:"MM/dd/yyyy",valueFormat:"MM/dd/yyyy",change:this.onInputLiveChange.bind(this)}))}}else if(t.DataType==="NUMBER"){e.setTemplate(new sap.m.Input({type:sap.m.InputType.Number,textAlign:sap.ui.core.TextAlign.Right,value:"{path:'"+a+"', formatOptions:{ minFractionDigits:"+t.Decimal+", maxFractionDigits:"+t.Decimal+" }, constraints:{ precision:"+t.Length+", scale:"+t.Decimal+" }}",liveChange:this.onNumberLiveChange.bind(this)}))}else if(t.DataType==="BOOLEAN"){e.setTemplate(new sap.m.CheckBox({selected:"{"+a+"}",editable:true}))}else{if(this._sActiveTable==="ioMatListTab"&&a==="MATDESC1"){e.setTemplate(new sap.m.Input({type:"Text",value:"{"+a+"}",maxLength:t.Length,change:this.onInputLiveChange.bind(this),enabled:{path:"MATNO",formatter:function(e){if(e!==""){return false}else{return true}}}}))}else if(this._sActiveTable==="costHdrTab"&&a==="VERDESC"){e.setTemplate(new sap.m.Input({type:"Text",value:"{"+a+"}",maxLength:t.Length,change:this.onInputLiveChange.bind(this),enabled:{path:"COSTSTATUS",formatter:function(e){if(e==="REL"){return false}else{return true}}}}))}else{e.setTemplate(new sap.m.Input({type:"Text",value:"{"+a+"}",maxLength:t.Length,change:this.onInputLiveChange.bind(this)}))}}if(t.Mandatory){e.getLabel().addStyleClass("sapMLabelRequired")}}})})},setRowReadMode(){var e=this.byId(this._sActiveTable);var t="";e.getColumns().forEach((e,a)=>{if(e.mAggregations.template.mBindingInfos.text!==undefined){t=e.mAggregations.template.mBindingInfos.text.parts[0].path}else if(e.mAggregations.template.mBindingInfos.selected!==undefined){t=e.mAggregations.template.mBindingInfos.selected.parts[0].path}else if(e.mAggregations.template.mBindingInfos.value!==undefined){t=e.mAggregations.template.mBindingInfos.value.parts[0].path}this._aColumns[this._sActiveTable.replace("Tab","")].filter(e=>e.ColumnName===t).forEach(a=>{if(a.TextFormatMode&&a.TextFormatMode!==""&&a.TextFormatMode!=="Key"&&a.ValueHelp&&a.ValueHelp["items"].text&&a.ValueHelp["items"].value!==a.ValueHelp["items"].text){e.setTemplate(new sap.m.Text({text:{parts:[{path:t}],formatter:function(e){var t=p.getView().getModel(a.ValueHelp["items"].path).getData().filter(t=>t[a.ValueHelp["items"].value]===e);if(t&&t.length>0){if(a.TextFormatMode==="Value"){return t[0][a.ValueHelp["items"].text]}else if(a.TextFormatMode==="ValueKey"){return t[0][a.ValueHelp["items"].text]+" ("+e+")"}else if(a.TextFormatMode==="KeyValue"){return e+" ("+t[0][a.ValueHelp["items"].text]+")"}}else return e}},wrapping:false}))}else if(a.DataType==="STRING"||a.DataType==="DATETIME"||a.DataType==="NUMBER"){e.setTemplate(new sap.m.Text({text:"{"+t+"}",wrapping:false}))}else if(a.DataType==="BOOLEAN"){e.setTemplate(new sap.m.CheckBox({selected:"{"+t+"}",editable:false}))}});e.getLabel().removeStyleClass("sapMLabelRequired")});this.byId(this._sActiveTable).getModel().getData().rows.forEach(e=>e.EDITED=false)},onTableResize:function(e){this._sActiveTable=e.getSource().data("TableId");var t=e.getSource().data("Max")==="1"?true:false;var a=e.getSource().data("ButtonIdSuffix");var s=e.getSource().data("Header");var i=this;this.byId("btnFullScreen"+a).setVisible(!t);this.byId("btnExitFullScreen"+a).setVisible(t);if(t){if(s==="1"){this.byId("splitterHdr").setProperty("size","100%");this.byId("splitterDtl").setProperty("size","0%")}else{this.byId("splitterHdr").setProperty("size","0%");this.byId("splitterDtl").setProperty("size","100%")}}else{this.byId("splitterHdr").setProperty("size","50%");this.byId("splitterDtl").setProperty("size","50%")}},onInputLiveChange:function(e){var t=e.getSource();var a=t.getBindingInfo("value").binding.oContext.sPath;this.byId(this._sActiveTable).getModel().setProperty(a+"/EDITED",true);if(this._sActiveTable==="headerTab")this._bHdrChanged=true;else if(this._sActiveTable==="detailTab")this._bDtlChanged=true},onNumberLiveChange:function(e){var t=e.getSource();var a=t.getBindingInfo("value").constraints.scale;var s=t.getBindingInfo("value").constraints.precision;if(e.getParameters().value.split(".")[0].length>s-a){e.getSource().setValueState("Error");e.getSource().setValueStateText("Enter a number with a maximum whole number length of "+(s-a));if(this._validationErrors.filter(t=>t===e.getSource().getId()).length===0){this._validationErrors.push(e.getSource().getId())}}else if(e.getParameters().value.split(".").length>1){if(a===0){e.getSource().setValueState("Error");e.getSource().setValueStateText("Enter a number without decimal place/s");if(this._validationErrors.filter(t=>t===e.getSource().getId()).length===0){this._validationErrors.push(e.getSource().getId())}}else{if(e.getParameters().value.split(".")[1].length>a){e.getSource().setValueState("Error");e.getSource().setValueStateText("Enter a number with a maximum of "+a.toString()+" decimal places");if(this._validationErrors.filter(t=>t===e.getSource().getId()).length===0){this._validationErrors.push(e.getSource().getId())}}else{e.getSource().setValueState("None");this._validationErrors.forEach((t,a)=>{if(t===e.getSource().getId()){this._validationErrors.splice(a,1)}})}}}else{e.getSource().setValueState("None");this._validationErrors.forEach((t,a)=>{if(t===e.getSource().getId()){this._validationErrors.splice(a,1)}})}var i=t.getBindingInfo("value").binding.oContext.sPath;this.byId(this._sActiveTable).getModel().setProperty(i+"/EDITED",true);if(this._sActiveTable==="headerTab")this._bHdrChanged=true;else if(this._sActiveTable==="detailTab")this._bDtlChanged=true},handleValueHelpChange:function(e){var a=e.getSource();var s=a.oParent.getBindingContext().sPath;var i=!a.getSelectedKey()&&a.getValue().trim();var r=a.getBindingInfo("suggestionItems").model;var l="VER";a.getSuggestionItems().forEach(e=>{if(a.getSelectedKey()===""&&a.getValue()!==""){if(a.getProperty("textFormatMode")==="ValueKey"&&e.getProperty("text")+" ("+e.getProperty("key")+")"===a.getValue()){a.setSelectedKey(e.getProperty("key"));i=false;a.setValueState(i?"Error":"None")}else if((a.getProperty("textFormatMode")==="Value"||a.getProperty("textFormatMode")==="Key")&&e.getProperty("key")===a.getValue()){a.setSelectedKey(e.getProperty("key"));i=false;a.setValueState(i?"Error":"None")}}else if(e.getProperty("key")===a.getSelectedKey()){i=false;a.setValueState(i?"Error":"None")}});if(i)this._validationErrors.push(e.getSource().getId());else{const e=this.byId(this._sActiveTable).getModel();switch(r){case"MTYP_MODEL":var o=this.getView().byId("headerTab");var n=p.getView().getModel("MTYP_MODEL").getData().filter(e=>e.Mattyp===a.getSelectedKey());e.setProperty(s+"/HASGMC",n[0].Hasgmc==="X"?true:false);e.setProperty(s+"/GROSSWT","0.000");e.setProperty(s+"/NETWT","0.000");e.setProperty(s+"/VOLUME","0.000");e.setProperty(s+"/UEBTK",false);e.setProperty(s+"/MATERIALGROUP","");e.setProperty(s+"/GMC","");e.setProperty(s+"/BASEUOM","");e.setProperty(s+"/WTUOM","");e.setProperty(s+"/VOLUMEUOM","");e.setProperty(s+"/MATERIALGROUP","");e.setProperty(s+"/CUSTMATCODE","");e.setProperty(s+"/PROCESSCODE","");e.setProperty(s+"/UEBTO","");e.setProperty(s+"/UNTTO","");e.setProperty(s+"/UEBTK",false);if(n[0].Hasgmc==="X"){o.getColumns().forEach((e,t)=>{const a=e.getId().replace(this._sActiveTable.replace("Tab","")+"Col","");switch(a){case"MATERIALGROUP":case"GROSSWT":case"NETWT":case"WTUOM":case"VOLUME":case"VOLUMEUOM":case"CUSTMATLNO":case"PROCESSCODE":case"ORDERUOM":case"BASEUOM":case"GROSSWT":{o.getRows()[0].getCells()[t].setProperty("editable",false);break}case"GMC":{o.getRows()[0].getCells()[t].setProperty("editable",true);break}}});this._oModel.read("/GMCRscSet",{urlParameters:{$filter:"Mattyp eq '"+a.getSelectedKey()+"' and Sbu eq '"+l+"'"},async:false,success:function(e){p.getView().setModel(new t(e.results),"GMC_MODEL")},error:function(e){}})}else{o.getColumns().forEach((e,t)=>{const a=e.getId().replace(this._sActiveTable.replace("Tab","")+"Col","");switch(a){case"MATERIALGROUP":case"GROSSWT":case"NETWT":case"WTUOM":case"VOLUME":case"VOLUMEUOM":case"CUSTMATLNO":case"PROCESSCODE":case"ORDERUOM":case"BASEUOM":case"GROSSWT":{o.getRows()[0].getCells()[t].setProperty("editable",true);break}case"GMC":{o.getRows()[0].getCells()[t].setProperty("editable",false);break}}})}break;case"GMC_MODEL":var d=p.getView().getModel("GMC_MODEL").getData().filter(e=>e.Gmc===a.getSelectedKey());e.setProperty(s+"/MATERIALGROUP","");e.setProperty(s+"/BASEUOM","");e.setProperty(s+"/GROSSWT","");e.setProperty(s+"/NETWT","");e.setProperty(s+"/WTUOM","");e.setProperty(s+"/VOLUME","");e.setProperty(s+"/VOLUMEUOM","");e.setProperty(s+"/CUSTMATCODE","");e.setProperty(s+"/MATERIALGROUP",d[0].Matgrpcd);e.setProperty(s+"/BASEUOM",d[0].Baseuom);e.setProperty(s+"/GROSSWT",d[0].Grswt);e.setProperty(s+"/NETWT",d[0].Netwt);e.setProperty(s+"/WTUOM",d[0].Wtuom);e.setProperty(s+"/VOLUME",d[0].Volume);e.setProperty(s+"/VOLUMEUOM",d[0].Voluom);e.setProperty(s+"/CUSTMATCODE",d[0].Cusmatcd);break;case"PURCHASEVALUE_MODEL":var u=p.getView().getModel("PURCHASEVALUE_MODEL").getData().filter(e=>e.Ekwsl===a.getSelectedKey());e.setProperty(s+"/UEBTO","");e.setProperty(s+"/UNTTO","");e.setProperty(s+"/UEBTK",false);e.setProperty(s+"/UEBTO",u[0].Uebto);e.setProperty(s+"/UNTTO",u[0].Untto);e.setProperty(s+"/UEBTK",u[0].Uebtk==="X"?true:false);break}}this.byId(this._sActiveTable).getModel().setProperty(s+"/EDITED",true);if(this._sActiveTable==="headerTab")this._bHdrChanged=true;else if(this._sActiveTable==="detailTab")this._bDtlChanged=true},onAddRow(){this.setRowCreateMode()},onRemoveRow(){var e=this.byId(this._sActiveTable);var t=e.getModel().getProperty("/rows").filter(e=>e.NEW===true);t.splice(e.getSelectedIndices(),1);e.getModel().setProperty("/rows",t);e.bindRows("/rows")},onSaveHdr(){var e=this.byId(this._sActiveTable).getModel().getData().rows.filter(e=>e.NEW===true);var i=this.byId(this._sActiveTable).getModel().getData().rows.filter(e=>e.EDITED===true);var r=this.getOwnerComponent().getModel();var l=this.getOwnerComponent().getModel();var o=new t;var n=new t;var d="VER";var u={results:[]};if(e.length>0){e.forEach((e,t)=>{e.NEWSEQ=t});this.onMaterialTypeClassDialog(e);e.forEach((t,s)=>{r.read("/MRPTypeSet",{urlParameters:{$filter:"Screencode eq 'BAPI_MATNR' and Mtart eq '"+t.MATERIALTYPE+"'"},success:function(t,a){if(t.results.length>0){u.results.push(t.results[0])}if(s==e.length-1){o.setData(u);p.getView().setModel(o,"mrpTypeClass")}},error:function(e){a.information(e)}})});l.read("/MatPlantSet",{urlParameters:{$filter:"SBU eq '"+d+"'"},success:function(e,t){n.setData(e);p.getView().setModel(n,"matPlantClass")},error:function(e){}})}else if(i.length>0){var r=this.getOwnerComponent().getModel();var g=0;var h=this;var c=true;var f={groupId:"update"};r.setUseBatch(true);r.setDeferredGroups(["update"]);i.forEach(e=>{var t="/MaterialSet(";var a={};var s=this._aColumns["header"].filter(e=>e.Key==="X").length;h._aColumns["header"].forEach(i=>{if(i.Editable)a[i.ColumnName]=e[i.ColumnName];if(s===1){if(i.Key)t+="'"+e[i.ColumnName]+"'"}else if(s>1){if(i.Key)t+=i.ColumnName+"='"+e[i.ColumnName]+"',"}});if(s>1)t=t.substring(0,t.length-1);t+=")";console.log("entitySet",t);console.log("param",a);r.update(t,a,f)});if(c){s.openProcessingDialog(p,"Processing...");r.submitChanges({groupId:"update",success:function(e,t){s.closeProcessingDialog(p);p.byId("btnAddHdr").setVisible(true);p.byId("btnEditHdr").setVisible(true);p.byId("btnAddRowHdr").setVisible(false);p.byId("btnRemoveRowHdr").setVisible(false);p.byId("btnSaveHdr").setVisible(false);p.byId("btnCancelHdr").setVisible(false);p.byId("btnDeleteHdr").setVisible(true);p.byId("btnRefreshHdr").setVisible(true);p.byId("btnFullScreenHdr").setVisible(true);p.byId("smartFilterBar").setVisible(true);p.byId(p._sActiveTable).getModel().setProperty("/rows",p._aDataBeforeChange);p.byId(p._sActiveTable).bindRows("/rows");if(p._aColFilters.length>0){p.setColumnFilters(p._sActiveTable)}if(p._aColSorters.length>0){p.setColumnSorters(p._sActiveTable)}p.byId("splitterHdr").setProperty("size","50%");p.byId("splitterDtl").setProperty("size","50%");p.getMain();p.setRowReadMode();p._dataMode="READ"},error:function(e,t){console.log(t)}})}}},createDialog:null,onMaterialTypeClassDialog(e){console.log("args",e);var a=this.getOwnerComponent().getModel();var s=new t;var i=this;var r={results:[]};var l=e.map(e=>e.MATERIALTYPE);console.log("aMatType",l);l.forEach((e,o)=>{this.newMattyp=e;a.read("/MatTypeClassSet",{urlParameters:{$filter:"Mattyp eq '"+this.newMattyp+"'"},success:function(e,a){console.log(e);var n=JSON.parse(JSON.stringify(e));n.results.forEach(e=>{e.Descen="";e.Desczh="";e.Attrib=e.Attrib==="X"?true:false;e.Createddt=f.format(new Date(e.Createddt));e.Updateddt=f.format(new Date(e.Updateddt));e.DescInput=e.Attrib==="X"?false:true});r.results.push(...n.results);if(o==l.length-1){r.results.forEach((e,t)=>{e.NEWSEQ=t});s.setData(r);i.getView().setModel(s,"mtClassModel");i.createViewSettingsDialog("matTypeClass",new t({items:r.results,rowCount:r.results.length}));var d=i._oViewSettingsDialog["zuimatmaster.view.fragments.MaterialTypeClassDialog"];d.getModel().setProperty("/items",r.results);d.getModel().setProperty("/rowCount",r.results.length);d.open()}},error:function(e){}})})},createViewSettingsDialog:function(e,t){var a=null;if(e==="sort")a="zuimatmaster.view.SortDialog";else if(e==="filter")a="zuimatmaster.view.FilterDialog";else if(e==="column")a="zuimatmaster.view.ColumnDialog";else if(e==="matTypeClass")a="zuimatmaster.view.fragments.MaterialTypeClassDialog";var s=this._oViewSettingsDialog[a];if(!s){s=sap.ui.xmlfragment(a,this);if(c.system.desktop){s.addStyleClass("sapUiSizeCompact")}s.setModel(t);this._oViewSettingsDialog[a]=s;this.getView().addDependent(s)}else{s.setModel(t)}},onCreateMMCancel(){this._oViewSettingsDialog["zuimatmaster.view.fragments.MaterialTypeClassDialog"].close()},onCreateMMSave(){var e="VER";var t=[],i=[];var r=this;this.getView().getModel("mtClassModel").getData().results.forEach(e=>{if(e.Desczh==="")e.Desczh=e.Descen;if(e.Inclindesc==="X"){if(e.Descen!=="")t.push(e.Descen);if(e.Desczh!=="")i.push(e.Desczh)}});if(t.join("")===""){a.information("At least one description should be specified.")}else{s.openProcessingDialog(p,"Processing...");var l=this.byId(this._sActiveTable).getModel().getData().rows.filter(e=>e.NEW===true);var o="";var n=false;var d=0;l.forEach((u,g)=>{t=[];i=[];r.getView().getModel("mtClassModel").getData().results.forEach(e=>{if(e.Mattyp==u.MATERIALTYPE&&e.NEWSEQ==u.NEWSEQ){if(e.Desczh==="")e.Desczh=e.Descen;if(e.Inclindesc==="X"){if(e.Descen!=="")t.push(e.Descen);if(e.Desczh!=="")i.push(e.Desczh)}}});var h=t.join(", ");var c=i.join(", ");var f={};var m="";var b=[];var T=[];r.getView().getModel("mtClassModel").getData().results.forEach((e,t)=>{if(e.Mattyp==u.MATERIALTYPE&&e.NEWSEQ==u.NEWSEQ){T.push({Seq:"1",Seqno:t+1+"",Mattypcls:e.Mattypcls,Attribcd:e.Attribcd,Descen:e.Descen,Desczh:e.Desczh})}});var M=r.getView().getModel("mrpTypeClass").getData().results.filter(e=>e.Mtart==u.MATERIALTYPE)[0];b.push({Seq:"1",Seqno:"1",Ind_sector:"J",Matl_type:u.MATERIALTYPE,Matl_group:u.MATERIALGROUP,Old_mat_no:u.OLDMATERIALNO,Base_uom:u.BASEUOM,Batch_mgmt:"X",Net_weight:u.NETWT,Unit_of_wt:u.WTUOM,Po_unit:u.ORDERUOM,Pur_valkey:u.PURCHVALUEKEY,Plant:r.getView().getModel("matPlantClass").getData().results[0].PLANTCD,Mrp_type:M.Dismm,Period_ind:"M",Proc_type:"F",Availcheck:"KP",Profit_ctr:r.getView().getModel("matPlantClass").getData().results[0].PROFITCTR,Val_area:r.getView().getModel("matPlantClass").getData().results[0].PLANTCD,Price_ctrl:u.MATERIALGROUP==="ACC"||u.MATERIALGROUP==="FAB"?"V":"",Moving_pr:"0",Price_unit:"1",Val_class:M.Bklas});f={Seq:"1",Mattyp:u.MATERIALTYPE,Gmc:u.GMC,Descen:h,Desczh:c,Processcd:u.PROCESSCODE,Cusmatno:u.CUSMATCODE,Grswt:u.GROSSWT,Volume:u.VOLUME,Voluom:u.VOLUMEUOM,Length:u.LENGTH+"",Width:u.WIDTH+"",Height:u.HEIGHT+"",Dimuom:u.DIMENSIONUOM,Remarks:"",MatAttribParamSet:T,MatImportParamSet:b,RetMsgSet:[{Seq:"1"}]};console.log("_param",f);d+=100;setTimeout(()=>{var t=r.getOwnerComponent().getModel("ZGW_3DERP_MATERIAL_SRV");t.setHeaders({sbu:e});t.create("/MaterialHdrSet",f,{method:"POST",success:function(e,t){s.closeProcessingDialog(p);if(e.RetMsgSet.results[0].Type!="S")n=true;o+=e.RetMsgSet.results[0].Message+"\n";if(g==l.length-1){if(n==false){p._oViewSettingsDialog["zuimatmaster.view.fragments.MaterialTypeClassDialog"].close();p.getMain();p.byId("smartFilterBar").setVisible(true);p.byId("splitterHdr").setProperty("size","50%");p.byId("splitterDtl").setProperty("size","50%");p.byId("btnAddHdr").setVisible(true);p.byId("btnEditHdr").setVisible(true);p.byId("btnAddRowHdr").setVisible(false);p.byId("btnRemoveRowHdr").setVisible(false);p.byId("btnSaveHdr").setVisible(false);p.byId("btnCancelHdr").setVisible(false);p.byId("btnDeleteHdr").setVisible(true);p.byId("btnFullScreenHdr").setVisible(true);p.setRowReadMode();p._dataMode="READ"}a.information(o);s.closeProcessingDialog(p)}},error:function(){s.closeProcessingDialog(p)}})},d)})}},onCancel:function(e){var t=e.getSource().oParent.oParent;var a=t.sId.split("--")[t.sId.split("--").length-1];this._sActiveTable=a;this.cancelData()},cancelData(){if(this._dataMode==="NEW"||this._dataMode==="EDIT"){var e=false;if(this._sActiveTable==="headerTab")e=this._bHdrChanged;if(e){var a={Action:"update-cancel",Text:this.getView().getModel("ddtext").getData()["CONFIRM_DISREGARD_CHANGE"]};var s=new t;s.setData(a);if(!this._ConfirmDialog){this._ConfirmDialog=sap.ui.xmlfragment("zuimatmaster.view.fragments.dialog.ConfirmDialog",this);this._ConfirmDialog.setModel(s);this.getView().addDependent(this._ConfirmDialog)}else this._ConfirmDialog.setModel(s);this._ConfirmDialog.open()}else{if(this._sActiveTable==="headerTab"){p.byId("btnAddHdr").setVisible(true);p.byId("btnEditHdr").setVisible(true);p.byId("btnAddRowHdr").setVisible(false);p.byId("btnRemoveRowHdr").setVisible(false);p.byId("btnSaveHdr").setVisible(false);p.byId("btnCancelHdr").setVisible(false);p.byId("btnDeleteHdr").setVisible(true);p.byId("btnRefreshHdr").setVisible(true);p.byId("btnFullScreenHdr").setVisible(true);this.byId("smartFilterBar").setVisible(true)}this.byId(this._sActiveTable).getModel().setProperty("/rows",this._aDataBeforeChange);this.byId(this._sActiveTable).bindRows("/rows");if(this._aColFilters.length>0){this.setColumnFilters(this._sActiveTable)}if(this._aColSorters.length>0){this.setColumnSorters(this._sActiveTable)}this.byId("splitterHdr").setProperty("size","50%");this.byId("splitterDtl").setProperty("size","50%");this.getMain();this.setRowReadMode();this._dataMode="READ"}}},onEdit(){if(this._dataMode==="READ"){if(this._sActiveTable==="headerTab"){this.byId("splitterHdr").setProperty("size","100%");this.byId("splitterDtl").setProperty("size","0%");this.byId("btnAddHdr").setVisible(false);this.byId("btnEditHdr").setVisible(false);this.byId("btnDeleteHdr").setVisible(false);this.byId("btnRefreshHdr").setVisible(false);this.byId("btnAddRowHdr").setVisible(true);this.byId("btnRemoveRowHdr").setVisible(true);this.byId("btnSaveHdr").setVisible(true);this.byId("btnCancelHdr").setVisible(true);this.byId("btnFullScreenHdr").setVisible(false);this.byId("btnExitFullScreenHdr").setVisible(false);this.byId("smartFilterBar").setVisible(false);this.onEditMain()}this._dataMode="EDIT"}},onEditMain(){var e=this.getOwnerComponent().getModel();var t="/MaterialSet";var s=this;var i=this.byId("headerTab");var r=i.getSelectedIndices();var l=[];var o=i.getModel().getData().rows;var n=[];var d=false,u=false;var g=0;if(r.length>0){r.forEach(e=>{l.push(i.getBinding("rows").aIndices[e])});r=l;r.forEach((a,i)=>{e.read(t,{urlParameters:{$filter:"MATERIALNO eq '"+o.at(a).MATERIALNO+"'"},success:function(e,t){g++;console.log(e.results);n.push(o.at(a));if(r.length===g){s.byId("headerTab").getModel().setProperty("/rows",n);s.byId("headerTab").bindRows("/rows");s.getView().getModel("counts").setProperty("/header",n.length);s.setRowEditMode("header")}},error:function(e){g++}})})}else{a.information(this.getView().getModel("ddtext").getData()["INFO_NO_SEL_RECORD_TO_PROC"])}},onCancelConfirmDialog:function(e){this._ConfirmDialog.close()},onCloseConfirmDialog:function(e){var t=e.getSource().oParent.oParent;var a=t.sId.split("--")[t.sId.split("--").length-1];this._sActiveTable="headerTab";if(this._sActiveTable==="headerTab"){p.byId("btnAddHdr").setVisible(true);p.byId("btnEditHdr").setVisible(true);p.byId("btnAddRowHdr").setVisible(false);p.byId("btnRemoveRowHdr").setVisible(false);p.byId("btnSaveHdr").setVisible(false);p.byId("btnCancelHdr").setVisible(false);p.byId("btnDeleteHdr").setVisible(true);p.byId("btnRefreshHdr").setVisible(true);p.byId("btnFullScreenHdr").setVisible(true);p.byId("smartFilterBar").setVisible(true)}this.byId(this._sActiveTable).getModel().setProperty("/rows",this._aDataBeforeChange);this.byId(this._sActiveTable).bindRows("/rows");if(this._aColFilters.length>0){this.setColumnFilters(this._sActiveTable)}if(this._aColSorters.length>0){this.setColumnSorters(this._sActiveTable)}this.byId("splitterHdr").setProperty("size","50%");this.byId("splitterDtl").setProperty("size","50%");this.getMain();this.setRowReadMode();this._dataMode="READ";this._ConfirmDialog.close()},onCellClick:function(e){if(e.getParameters().rowBindingContext){var t=e.getSource();var a=e.getParameters().rowBindingContext.sPath;var i=t.getModel().getProperty(a+"/MATERIALNO");if(t.getId().indexOf("headerTab")>=0){s.openLoadingDialog(p);p.getView().getModel("ui").setProperty("/acitveMatno",i);p.getAttributes(i);p.getBatch(i);p.getCustomInfo(i);p.getPlant(i);p.getUnit(i);if(this._dataMode==="READ")this._sActiveTable="headerTab"}else{if(this._dataMode==="READ")this._sActiveTable="detailTab"}t.getModel().getData().rows.forEach(e=>e.ACTIVE="");t.getModel().setProperty(a+"/ACTIVE","X");t.getRows().forEach(e=>{if(e.getBindingContext()&&e.getBindingContext().sPath.replace("/rows/","")===a.replace("/rows/","")){e.addStyleClass("activeRow")}else e.removeStyleClass("activeRow")})}},onExtendMaterial:async function(){var e=this;var a=this.getOwnerComponent().getModel();var s=p.getView().getModel("ui").getProperty("/acitveMatno");var i="VER";var r={};var l=new t;var o=new t;var n=[];var d=[];var u=[];var g=[];await new Promise((e,t)=>{a.read("/ExtendMaterialChkSet",{urlParameters:{$filter:"MATNO eq '"+s+"'"},success:async function(t,a){console.log("ExtMatChk",t.results);n=t.results;e()},error:function(){e()}})});await new Promise((e,t)=>{a.read("/ExtendMaterialSet",{urlParameters:{$filter:"SBU eq '"+i+"'"},success:async function(t,a){console.log("ExtMat",t.results);d=t.results;e()},error:function(){e()}})});await new Promise((e,t)=>{d.filter(function(t,a){n.forEach(e=>{if(t.PLANTCD===e.PLANTCD){delete d[a]}});e()});d.forEach(e=>{g.push(e)});e()});l.setData(g);e.getView().setModel(l,"mmExtendTblData");console.log("mmExtendTblData",p.getView().getModel("mmExtendTblData").getData());r={Title:"Extend Material"};o.setData(r);e.onExtendMaterialDialog=sap.ui.xmlfragment(e.getView().getId(),"zuimatmaster.view.fragments.dialog.MMExtendDialog",e);e.onExtendMaterialDialog.setModel(o);e.getView().addDependent(e.onExtendMaterialDialog);var c=h.sap.getModulePath("zuimatmaster","/model/columns.json");var f=new t;await f.loadData(c);var m=f.getData();this._oModelColumns=f.getData();var b=new Promise((e,t)=>{e(this.getDynamicColumns("MMExtend","ZDV_MMEXTEND","mmExtendTbl",m))});await b;p.byId("mmExtendTbl").getModel().setProperty("/rows",p.getView().getModel("mmExtendTblData").getData());p.byId("mmExtendTbl").bindRows("/rows");e.onExtendMaterialDialog.open()},onCancelExtendMM:async function(){this.onExtendMaterialDialog.destroy(true)},onSaveExtendMaterial:async function(){var e=this;var t=this.getOwnerComponent().getModel();var i=this.getOwnerComponent().getModel("ZGW_3DERP_MATERIAL_SRV");var r=e.getView().getModel("ui").getProperty("/acitveMatno");var l=this.byId("mmExtendTbl");var o=l.getSelectedIndices();var n=[];var d=l.getModel().getData().rows;var u=false;var g="";var h=0;var c={};var f={};var m=[];if(o.length>0){s.openLoadingDialog(this);o.forEach(e=>{n.push(l.getBinding("rows").aIndices[e])});o=n;for(var b in o){await new Promise((e,a)=>{h++;t.read("/ExtendMaterialVldMatChkSet",{urlParameters:{$filter:"MATNO eq '"+r+"'"},success:async function(t,a){if(t.results.length>0){u=true;e(g=t.results[0].PLANTCD)}e()},error:function(){e()}})});if(u){f={Subrc:0};m.push({Row:0,Matnr:r,WerksFrom:g,WerksTo:d.at(b).PLANTCD})}if(o.length===h){c=f;c["N_IMatPlant"]=m;c["N_EMatPlant"]=[];c["N_Messtab"]=[];if(m.length>0){await new Promise((e,t)=>{i.create("/MatExtendSet",c,{method:"POST",success:function(t,s){const i=t.N_Messtab.results.length-1;if(t.N_Messtab.results[i].Type==="S"){a.information(t.N_Messtab.results[0].Message)}else if(t.N_Messtab.results[i].Type==="E"){a.error(Object.values(t.N_Messtab.results).pop().Message)}e()},error:function(t){e()}})})}else{a.error("No valid Purchasing Plant found.")}}}s.closeLoadingDialog(p);this.onExtendMaterialDialog.destroy(true);this.getPlant(r)}else{a.warning("No Selected Record!")}},formatValueHelp:function(e,t,a,s,i){if(this.getView().getModel(t)===undefined){return e}var r=this.getView().getModel(t).getData().filter(t=>t[a]===e);if(r&&r.length>0){if(i==="Value"){return r[0][s]}else if(i==="ValueKey"){return r[0][s]+" ("+e+")"}else if(i==="KeyValue"){return e+" ("+r[0][s]+")"}else{return e}}else return e},onKeyUp(e){if((e.key==="ArrowUp"||e.key==="ArrowDown")&&e.srcControl.sParentAggregationName==="rows"){var t=this.byId(e.srcControl.sId).oParent;if(this.byId(e.srcControl.sId).getBindingContext()){var a=this.byId(e.srcControl.sId).getBindingContext().sPath;var s=t.getModel().getProperty(a+"/MATERIALNO");t.getModel().getData().rows.forEach(e=>e.ACTIVE="");t.getModel().setProperty(a+"/ACTIVE","X");p.getView().getModel("ui").setProperty("/acitveMatno",s);t.getRows().forEach(e=>{if(e.getBindingContext()&&e.getBindingContext().sPath.replace("/rows/","")===a.replace("/rows/","")){e.addStyleClass("activeRow")}else e.removeStyleClass("activeRow")});p.getAttributes(s);p.getBatch(s);p.getCustomInfo(s);p.getPlant(s);p.getUnit(s)}if(t.getId().indexOf("headerTab")>=0){var i=this.byId("detailTab");var r=i.getColumns();for(var l=0,o=r.length;l<o;l++){if(r[l].getSorted()){r[l].setSorted(false)}}}}else if(e.key==="Enter"&&e.srcControl.sParentAggregationName==="cells"){if(this._dataMode==="NEW")this.onAddNewRow()}},onDelete:function(e){var t=e.getSource().oParent.oParent;var a=t.sId.split("--")[t.sId.split("--").length-1];this._sActiveTable=a;this.deleteData()},deleteData(){if(this._dataMode==="READ"){var e=this.byId(this._sActiveTable);var t=e.getSelectedIndices();var i=[];var r=e.getModel().getData().rows;if(t.length===0){a.information(this.getView().getModel("ddtext").getData()["INFO_NO_SEL_RECORD_TO_PROC"])}else{if(t.length>1){this.byId("headerTab").clearSelection();a.information("Please select one record only.")}else{t.forEach(t=>{i.push(e.getBinding("rows").aIndices[t])});t=i;a.confirm("Proceed to delete record?",{actions:["Yes","No"],onClose:function(e){if(e==="Yes"){s.openProcessingDialog(p,"Processing...");if(p.byId(p._sActiveTable).getBinding("rows").aFilters.length>0){p._aColFilters=p.byId(p._sActiveTable).getBinding("rows").aFilters}if(p.byId(p._sActiveTable).getBinding("rows").aSorters.length>0){p._aColSorters=p.byId(p._sActiveTable).getBinding("rows").aSorters}t.forEach(e=>{var t=p.getOwnerComponent().getModel();var a="/MaterialSet('"+r.at(e)["MATERIALNO"]+"')";var i={Deleted:"X"};t.update(a,i,{method:"PUT",success:function(t){p.getMain();s.closeProcessingDialog(p);sap.m.MessageBox.information("Material No : "+r.at(e)["MATERIALNO"]+" has been successfully deleted!")},error:function(e,t){s.closeProcessingDialog(p);sap.m.MessageBox.warning(e.message)}})})}}})}}}}})});